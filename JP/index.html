<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œå‰èªªæ˜æœƒç”¢ç”Ÿå™¨ V32 (ç¸½è¡¨CSVæ ¼å¼ä¿®æ­£ç‰ˆ)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è£œä¸Š Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    colors: {
                        'jp-indigo': '#2B3A55',
                        'jp-red': '#B93E38',
                        'jp-bg': '#F5F5F0',
                        'jp-dark': '#1a202c',
                        'jp-card-dark': '#2d3748'
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", -apple-system, sans-serif; }
        
        .phone-frame {
            border: 14px solid #1a1a1a;
            border-radius: 40px;
            overflow: hidden;
            position: relative;
            background: white;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .phone-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 25px;
            background: #1a1a1a;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            z-index: 50;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- é è¨­è³‡æ–™ ---
        const DEFAULT_DATA = {
            tripName: "å†¬å­£å…¸è—åå¤å±‹å¹»å½©é»ç‡ˆxå¾¡åœ¨æ‰€æ¨¹å†°ç©é›ªè¶£5æ—¥-JX8277",
            tripCode: "2026NGO0213JX05A",
            dateRange: "2026/02/13", 
            meeting: { 
                date: "2026/02/13", 
                time: "12:25", 
                location: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ç¬¬ä¸€èˆªç«™ æ˜Ÿå®‡èˆªç©º\nåœ˜é«”æ«ƒå°å‰é›†åˆ", 
                badge: "æ—¥æœ¬ç²¾ç·»å‡æœŸ(ç´…)", 
                airportStaff: "æ›¾ä»æ° 0910-008-139" 
            },
            guide: { name: "æ¸¸é¦¥è‚²", twPhone: "0958-105-306", localPhone: "080-3975-5756" },
            flights: [
                { 
                    type: "å»ç¨‹", airline: "æ˜Ÿå®‡èˆªç©º", code: "JX838", date: "02/13",
                    depTime: "14:55", depAirport: "TPE æ¡ƒåœ’", 
                    arrTime: "18:30", arrAirport: "NGO åå¤å±‹" 
                },
                { 
                    type: "å›ç¨‹", airline: "æ˜Ÿå®‡èˆªç©º", code: "JX839", date: "02/17",
                    depTime: "19:40", depAirport: "NGO åå¤å±‹", 
                    arrTime: "22:10", arrAirport: "TPE æ¡ƒåœ’" 
                }
            ],
            days: [
                { 
                    day: 1, 
                    date: "2/13", 
                    location: "åå¤å±‹", 
                    lat: 34.85, lon: 136.81, 
                    spots: [{ name: "ä¸­éƒ¨åœ‹éš›ç©ºæ¸¯", desc: "æŠµé”åå¤å±‹ï¼Œå‰å¾€é£¯åº—ä¼‘æ¯ã€‚" }],
                    meals: { b: "æ©Ÿä¸Š", l: "æ©Ÿä¸Š", d: "æ—¥å¼ä¾¿ç•¶+èŒ¶" },
                    hotel: "Comfort ä¸­éƒ¨åœ‹éš›ç©ºæ¸¯ é£¯åº—",
                    hotelTel: "0569-38-7211",
                    hotelAddress: "æ„›çŸ¥çœŒå¸¸æ»‘å¸‚ã‚»ãƒ³ãƒˆãƒ¬ã‚¢4-2-3"
                },
                { 
                    day: 2, 
                    date: "2/14", 
                    location: "é«˜å±±", 
                    lat: 36.14, lon: 137.25,
                    spots: [
                        { name: "æƒ é‚£å³¡å±•æœ›å°", desc: "æ¬£è³å£¯éº—çš„å³½è°·æ™¯è‰²ã€‚" },
                        { name: "æƒ é‚£å³½éŠèˆ¹", desc: "æ­ä¹˜éŠèˆ¹è¿‘è·é›¢è§€è³å¥‡å²©æ€ªçŸ³ã€‚" }
                    ],
                    meals: { b: "é£¯åº—å…§", l: "é¢¨å‘³é¤", d: "é£¯åº—å…§" },
                    hotel: "Hotel and Spa é«˜å±±é£¯åº—",
                    hotelTel: "0577-32-6210",
                    hotelAddress: "å²é˜œçœŒé«˜å±±å¸‚å¤©æº€ç”º5-13"
                },
                { 
                    day: 3, 
                    date: "2/15", 
                    location: "ä¸‹å‘‚", 
                    lat: 35.80, lon: 137.24,
                    spots: [
                        { name: "ç™½å·é„‰åˆæŒæ‘", desc: "ä¸–ç•Œæ–‡åŒ–éºç”¢ï¼Œç«¥è©±èˆ¬çš„åˆæŒé€ å»ºç¯‰ã€‚" }
                    ],
                    meals: { b: "é£¯åº—å…§", l: "é£›é©’ç‰›é¢¨å‘³é¤", d: "é£¯åº—å…§è‡ªåŠ©é¤" },
                    hotel: "å¤§æ±Ÿæˆ¶æº«æ³‰ç‰©èª ä¸‹å‘‚æœ¬é¤¨é£¯åº—",
                    hotelTel: "050-3615-3456",
                    hotelAddress: "å²é˜œçœŒä¸‹å‘‚å¸‚æ¹¯ä¹‹å³¶535"
                },
                { 
                    day: 4, 
                    date: "2/16", 
                    location: "åå¤å±‹", 
                    lat: 35.18, lon: 136.90,
                    spots: [
                        { name: "çŠ¬å±±åŸ", desc: "æ—¥æœ¬åœ‹å¯¶äº”åŸä¹‹ä¸€ï¼Œæ­·å²æ‚ ä¹…ã€‚" }
                    ],
                    meals: { b: "é£¯åº—å…§", l: "æ—¥å¼å®šé£Ÿ", d: "æ–¹ä¾¿éŠç©æ•¬è«‹è‡ªç†" },
                    hotel: "åå¤å±‹æ±æ€¥ é£¯åº—",
                    hotelTel: "052-251-2411",
                    hotelAddress: "æ„›çŸ¥çœŒåå¤å±‹å¸‚ä¸­åŒºæ „4-6-8"
                },
                { 
                    day: 5, 
                    date: "2/17", 
                    location: "å°åŒ—", 
                    lat: 25.03, lon: 121.56,
                    spots: [
                        { name: "ä¸­éƒ¨åœ‹éš›ç©ºæ¸¯", desc: "æ­æ©Ÿè¿”å›æº«æš–çš„å®¶ã€‚" }
                    ],
                    meals: { b: "é£¯åº—å…§", l: "æ©Ÿä¸Š", d: "æº«æš–çš„å®¶" },
                    hotel: "æº«æš–çš„å®¶",
                    hotelTel: "",
                    hotelAddress: ""
                }
            ],
            info: {
                weather: "2æœˆæ°£æº«ç´„0-8åº¦ï¼Œå±±å€æœƒæ›´å†·ä¸”æœ‰é›ªã€‚è«‹å‹™å¿…æº–å‚™ä¿æš–å¤§è¡£ã€æ‰‹å¥—ã€åœå·¾ã€æ¯›å¸½åŠé˜²æ»‘é‹ã€‚",
                currency: "æ—¥å¹£ (JPY)ã€‚å»ºè­°å°ç£å…ˆæ›åŒ¯ã€‚è¨±å¤šåº—å®¶å¯åˆ·å¡æˆ–ç”¨ PayPay/LINE Payã€‚",
                voltage: "100V é›™å­”æ‰æ’ (èˆ‡å°ç£ç›¸åŒï¼Œå…è½‰æ¥é ­)ã€‚",
                baggage: "åš´ç¦æ”œå¸¶è‚‰é¡å…¥å¢ƒã€‚è¡Œå‹•é›»æºè«‹éš¨èº«æ”œå¸¶ã€‚æ¯äººæ‰˜é‹è¡Œæé€šå¸¸ç‚º1ä»¶23å…¬æ–¤(ä¾èˆªç©ºå…¬å¸è¦å®š)ã€‚",
                imageRoot: "",
                pdfPath: "",
                surveyUrl: "", // æ–°å¢å•å·ç¶²å€
                tips: {
                    perDay: 300,
                    days: 5,
                    currency: "æ–°å°å¹£"
                }
            }
        };

        const CITIES = {
            "å°åŒ—": { lat: 25.03, lon: 121.56 },
            "æ±äº¬": { lat: 35.68, lon: 139.76 },
            "å¤§é˜ª": { lat: 34.69, lon: 135.50 },
            "äº¬éƒ½": { lat: 35.01, lon: 135.76 },
            "åå¤å±‹": { lat: 35.18, lon: 136.90 },
            "é«˜å±±": { lat: 36.14, lon: 137.25 },
            "ç™½å·é„‰": { lat: 36.25, lon: 136.90 },
            "ä¸‹å‘‚": { lat: 35.80, lon: 137.24 },
            "ä»™å°": { lat: 38.26, lon: 140.86 },
            "å±±å½¢(è—ç‹)": { lat: 38.25, lon: 140.33 },
            "ç¦å³¶(æœƒæ´¥)": { lat: 37.49, lon: 139.93 },
            "é’æ£®": { lat: 40.82, lon: 140.74 },
            "å²©æ‰‹(ç››å²¡)": { lat: 39.70, lon: 141.15 },
            "ç§‹ç”°": { lat: 39.72, lon: 140.10 },
            "ç¦å²¡": { lat: 33.59, lon: 130.40 },
            "åˆ¥åºœ": { lat: 33.28, lon: 131.50 },
            "ç†Šæœ¬": { lat: 32.80, lon: 130.70 },
            "é•·å´": { lat: 32.75, lon: 129.87 }
        };

        // --- Client HTML ç”Ÿæˆ ---
        function getClientHtml(data) {
            const jsonStr = JSON.stringify(data);
            
            // è­˜åˆ¥ç‰Œé¡è‰²é‚è¼¯
            let badgeColorClass = "bg-blue-600";
            if (data.meeting.badge.includes("ç´…")) badgeColorClass = "bg-red-600";
            else if (data.meeting.badge.includes("é»ƒ")) badgeColorClass = "bg-yellow-500";
            else if (data.meeting.badge.includes("ç¶ ")) badgeColorClass = "bg-green-600";
            
            // è¨ˆç®—ç¸½æœå‹™è²»
            const totalTips = (data.info.tips.perDay * data.info.tips.days).toLocaleString();
            
            // è™•ç†åœ–ç‰‡è·¯å¾‘é‚è¼¯
            let imageList = [];
            let imgInput = (data.info.imageRoot || "").trim();
            
            if (imgInput) {
                // 1. å¦‚æœåŒ…å«æ›è¡Œæˆ–é€—è™Ÿï¼Œè¦–ç‚ºå¤šå¼µåœ–ç‰‡çš„æ¸…å–®
                if (imgInput.includes("\n") || imgInput.includes(",")) {
                    imageList = imgInput.split(/[\n,]+/).map(s => s.trim()).filter(s => s);
                } 
                // 2. å¦‚æœçœ‹èµ·ä¾†åƒæ˜¯å–®ä¸€æª”æ¡ˆ (çµå°¾æ˜¯å‰¯æª”å)ï¼Œä¹Ÿè¦–ç‚ºå–®å¼µåœ–ç‰‡ (é¿å…è¢«ç•¶æˆè³‡æ–™å¤¾)
                else if (/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(imgInput)) {
                    imageList = [imgInput];
                }
                // 3. å¦å‰‡è¦–ç‚ºè³‡æ–™å¤¾è·¯å¾‘ (èˆŠæœ‰é‚è¼¯: è‡ªå‹•æŠ“ img1~8)
                else {
                    const path = imgInput.endsWith('/') ? imgInput : imgInput + '/';
                    imageList = [1,2,3,4,5,6,7,8].map(i => `${path}img${i}.jpg`);
                }
            }

            // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºå¸æ©Ÿå¡æç¤º (åªæœ‰ç•¶è‡³å°‘æœ‰ä¸€å¤©æœ‰å¡«å¯«åœ°å€æ™‚æ‰é¡¯ç¤º)
            const showDriverCardHint = data.days.some(d => d.hotelAddress && d.hotelAddress.trim() !== "");
            
            const htmlParts = [
                '<!DOCTYPE html>',
                '<html lang="zh-TW">',
                '<head>',
                '    <meta charset="UTF-8">',
                '    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">',
                `    <title>${data.tripName}</title>`,
                '    <script src="https://cdn.tailwindcss.com"><\/script>',
                '    <script>',
                '        tailwind.config = {',
                '            darkMode: "media",',
                '            theme: {',
                '                extend: {',
                '                    colors: {',
                '                        "jp-indigo": "#2B3A55",',
                '                        "jp-red": "#B93E38",',
                '                        "jp-bg": "#F5F5F0",',
                '                        "jp-dark": "#1a202c",',
                '                        "jp-card-dark": "#2d3748"',
                '                    }',
                '                }',
                '            }',
                '        }',
                '    <\/script>',
                '    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">',
                '    <style>',
                '        @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap");',
                '        body { font-family: "Noto Sans TC", "Noto Sans JP", sans-serif; background-color: #F5F5F0; -webkit-tap-highlight-color: transparent; }',
                '        .no-scrollbar::-webkit-scrollbar { display: none; }',
                '        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }',
                '        .card-shadow { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }',
                '        .seigaiha-pattern {',
                '            background-color: #2B3A55;',
                '            background-image: radial-gradient(circle at 100% 150%, #2B3A55 24%, #364663 25%, #364663 28%, #2B3A55 29%, #2B3A55 36%, #364663 36%, #364663 40%, transparent 40%, transparent),',
                '            radial-gradient(circle at 0 150%, #2B3A55 24%, #364663 25%, #364663 28%, #2B3A55 29%, #2B3A55 36%, #364663 36%, #364663 40%, transparent 40%, transparent),',
                '            radial-gradient(circle at 50%  100%, #364663 10%, #2B3A55 11%, #2B3A55 23%, #364663 24%, #364663 30%, #2B3A55 31%, #2B3A55 43%, #364663 44%, #364663 50%, #2B3A55 51%, #2B3A55 63%, #364663 64%, #364663 71%, transparent 71%, transparent),',
                '            radial-gradient(circle at 100% 50%, #364663 5%, #2B3A55 6%, #2B3A55 15%, #364663 16%, #364663 20%, #2B3A55 21%, #2B3A55 30%, #364663 31%, #364663 35%, #2B3A55 36%, #2B3A55 45%, #364663 46%, #364663 49%, transparent 50%, transparent),',
                '            radial-gradient(circle at 0 50%, #364663 5%, #2B3A55 6%, #2B3A55 15%, #364663 16%, #364663 20%, #2B3A55 21%, #2B3A55 30%, #364663 31%, #364663 35%, #2B3A55 36%, #2B3A55 45%, #364663 46%, #364663 49%, transparent 50%, transparent);',
                '            background-size: 30px 15px;',
                '        }',
                '        .tab-active { color: #2B3A55; border-bottom: 3px solid #B93E38; font-weight: 700; }',
                '        @media (prefers-color-scheme: dark) {',
                '            .tab-active { color: #ffffff; border-bottom: 3px solid #F87171; }',
                '            .seigaiha-pattern { background-color: #1a202c; }',
                '        }',
                '        .tab-inactive { color: #A0AEC0; }',
                '        .weather-tag { display: inline-flex; align-items: center; font-size: 0.7rem; padding: 2px 8px; border-radius: 9999px; margin-right: 4px; border: 1px solid rgba(0,0,0,0.05); }',
                '        .detail-content { transition: all 0.3s ease; }',
                '        .rotate-180 { transform: rotate(180deg); }',
                '        .custom-checkbox input:checked + div { background-color: #2B3A55; border-color: #2B3A55; }',
                '        .custom-checkbox input:checked + div:after { content: "âœ“"; color: white; display: block; text-align: center; line-height: 20px; font-size: 14px; }',
                '        @media (prefers-color-scheme: dark) {',
                '             .custom-checkbox input:checked + div { background-color: #4A5568; border-color: #4A5568; }',
                '        }',
                '    </style>',
                '</head>',
                '<body class="bg-jp-bg text-gray-700 h-screen flex flex-col max-w-md mx-auto shadow-2xl relative overflow-hidden dark:bg-jp-dark dark:text-gray-200 transition-colors duration-300">',
                '',
                '    <div id="app-header" class="fixed top-0 w-full max-w-md z-50 bg-jp-bg dark:bg-jp-dark transition-colors duration-300 shadow-sm">',
                '        <div class="seigaiha-pattern pt-8 pb-4 px-6 text-white">',
                '            <div class="flex justify-between items-end">',
                '                <div>',
                '                    <p class="text-[10px] font-bold tracking-[0.2em] opacity-80 uppercase mb-1">è¡Œå‹•èªªæ˜æœƒ(æ¸¬è©¦ä¸­)</p>',
                `                    <h1 class="text-xl font-bold leading-tight">${data.tripName}</h1>`,
                '                    <p class="text-xs opacity-90 mt-1 font-light flex items-center gap-2">',
                `                        <span><i class="far fa-calendar-alt mr-1"></i> ${data.meeting.date} å‡ºç™¼</span>`,
                `                        <span class="bg-white/20 px-2 py-0.5 rounded text-[10px]">${data.tripCode}</span>`,
                '                    </p>',
                '                </div>',
                '                <div class="text-right">',
                '                     <div id="location-label" class="text-[10px] opacity-70 mb-1"><i class="fas fa-map-marker-alt mr-1"></i>åµæ¸¬ä¸­...</div>',
                '                     <div id="header-weather" class="text-2xl font-light">--<span class="text-sm">Â°C</span></div>',
                '                </div>',
                '            </div>',
                '        </div>',
                '        <nav class="flex justify-around border-b border-gray-100 dark:border-gray-700 bg-white dark:bg-jp-card-dark">',
                '            <button onclick="switchTab(\'itinerary\')" id="btn-itinerary" class="flex-1 py-3 text-sm tab-active transition-all"><i class="fas fa-map-signs mr-1"></i> è¡Œç¨‹</button>',
                '            <button onclick="switchTab(\'info\')" id="btn-info" class="flex-1 py-3 text-sm tab-inactive transition-all"><i class="fas fa-info-circle mr-1"></i> è³‡è¨Š</button>',
                '            <button onclick="switchTab(\'tools\')" id="btn-tools" class="flex-1 py-3 text-sm tab-inactive transition-all"><i class="fas fa-suitcase mr-1"></i> å·¥å…·</button>',
                '        </nav>',
                '    </div>',
                '',
                '    <!-- Dynamic padding-top handled by JS -->',
                '    <main class="flex-1 overflow-y-auto no-scrollbar pb-10 px-4" id="main-content">',
                '        ',
                '        <div id="view-itinerary" class="space-y-4 pb-10">',
                '            ',
                '            <div class="bg-white dark:bg-jp-card-dark rounded-xl p-4 shadow-sm border-l-4 border-jp-red relative overflow-hidden card-shadow">',
                '                <div class="flex justify-between items-start mb-3">',
                '                    <div class="flex-1">',
                '                        <h3 class="text-sm font-bold text-gray-800 dark:text-gray-100 mb-2 flex items-center gap-2"><i class="far fa-clock text-jp-red"></i> é›†åˆè³‡è¨Š</h3>',
                '                        <div class="flex gap-4">',
                '                            <div>',
                '                                <p class="text-[10px] text-gray-400">é›†åˆæ™‚é–“</p>',
                `                                <p class="text-xl font-bold text-jp-red">${data.meeting.time}</p>`,
                '                            </div>',
                '                        </div>',
                '                        <div class="mt-2">',
                '                            <p class="text-[10px] text-gray-400">é›†åˆåœ°é»</p>',
                `                            <p class="text-sm text-gray-600 dark:text-gray-300 leading-tight font-medium whitespace-pre-wrap">${data.meeting.location}</p>`,
                '                        </div>',
                '                         <div class="mt-2">',
                '                            <p class="text-[10px] text-gray-400">è­˜åˆ¥ç‰Œ</p>',
                `                            <span class="inline-block ${badgeColorClass} text-white text-xs px-2 py-0.5 rounded shadow-sm">${data.meeting.badge}</span>`,
                '                        </div>',
                '                    </div>',
                '                    <div class="text-right pl-2 border-l border-dashed border-gray-200 dark:border-gray-600 flex flex-col items-center justify-center min-w-[70px]">',
                `                        <p class="text-[10px] text-gray-400 mb-1">å°éŠ ${data.guide.name}</p>`,
                `                        <button onclick="callGuide('${data.guide.twPhone}')" class="flex flex-col items-center justify-center w-12 h-12 bg-green-500 text-white rounded-full shadow-lg active:scale-95 transition-transform"><i class="fas fa-phone text-xl"></i></button>`,
                `                        <p class="text-[10px] text-gray-500 mt-1">${data.guide.twPhone}</p>`,
                '                    </div>',
                '                </div>',
                data.meeting.airportStaff ? `                <div class="pt-2 border-t border-dashed border-gray-200 dark:border-gray-600 text-xs text-gray-500 dark:text-gray-400 flex justify-between"><span>æ©Ÿå ´å°ˆå“¡</span><span>${data.meeting.airportStaff}</span></div>` : '',
                '            </div>',
                '',
                data.days.map((day, idx) => `
                <div class="bg-white dark:bg-jp-card-dark rounded-xl shadow-sm overflow-hidden p-5 transition-colors card-shadow">
                    <div class="flex justify-between items-start mb-3 border-b border-gray-100 dark:border-gray-700 pb-2">
                        <div>
                            <h2 class="font-bold text-lg text-jp-indigo dark:text-blue-200">DAY ${day.day} <span class="text-xs font-normal text-gray-400 ml-2">${day.date}</span></h2>
                            <div id="weather-stats-${idx}" class="mt-2 flex flex-wrap gap-y-2"><span class="text-xs text-gray-400">è¼‰å…¥ä¸­...</span></div>
                        </div>
                        <div id="weather-icon-${idx}" class="text-2xl text-gray-300"></div>
                    </div>

                    <div class="space-y-4 relative pl-4 border-l-2 border-gray-100 dark:border-gray-600 pb-2 pt-2">
                        <p class="text-[10px] text-gray-400 absolute -top-2 left-2 bg-white dark:bg-jp-card-dark px-1">${day.location || 'è¡Œç¨‹'}</p>
                        
                        ${day.spots.map((spot, sIdx) => `
                        <div class="relative cursor-pointer group" onclick="toggleDetail(this)">
                            <div class="absolute -left-[21px] top-1 w-3 h-3 ${sIdx % 2 === 0 ? 'bg-green-500' : 'bg-blue-400'} rounded-full border-2 border-white dark:border-gray-600"></div>
                            <div class="flex justify-between items-center">
                                <h3 class="font-bold text-gray-800 dark:text-gray-100 text-sm leading-tight">${spot.name}</h3>
                                <i class="fas fa-chevron-down text-xs text-gray-300 transition-transform duration-300 mt-1"></i>
                            </div>
                            <div class="detail-content hidden mt-2 text-sm text-gray-600 dark:text-gray-300 bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg leading-relaxed text-justify">
                                ${spot.desc || 'ç„¡è©³ç´°ä»‹ç´¹'}
                            </div>
                        </div>
                        `).join('')}

                        <div class="relative cursor-pointer" onclick="${day.hotelAddress ? `showHotelCard('${day.hotel}', '${day.hotelTel}', '${day.hotelAddress}', 'Day ${day.day}')` : ''}">
                            <div class="absolute -left-[21px] top-1 w-3 h-3 bg-purple-400 rounded-full border-2 border-white dark:border-gray-600"></div>
                            <div class="flex justify-between items-center">
                                <h3 class="font-bold text-gray-800 dark:text-gray-100 text-sm"><i class="fas fa-bed text-purple-400 mr-1"></i> ${day.hotel}</h3>
                                ${day.hotelAddress ? '<i class="fas fa-search-plus text-gray-300 text-xs"></i>' : ''}
                            </div>
                            <p class="text-[10px] text-gray-400 pl-5 mt-1">${day.hotel.includes('æº«æš–çš„å®¶') ? '' : `TEL: ${day.hotelTel || 'è©³æ´½é ˜éšŠ'}`}</p>
                        </div>
                    </div>

                    <div class="mt-3 bg-gray-50 dark:bg-gray-700 rounded-lg p-3 text-sm text-gray-600 dark:text-gray-300 space-y-1">
                        <div class="flex"><span class="w-8 font-bold text-gray-400 text-xs pt-0.5">æ—©é¤</span> <span class="flex-1">${day.meals.b}</span></div>
                        <div class="flex"><span class="w-8 font-bold text-gray-400 text-xs pt-0.5">åˆé¤</span> <span class="flex-1">${day.meals.l}</span></div>
                        <div class="flex"><span class="w-8 font-bold text-gray-400 text-xs pt-0.5">æ™šé¤</span> <span class="flex-1">${day.meals.d}</span></div>
                    </div>
                </div>
                `).join(''),
                '',
                '            <div class="text-center text-xs text-gray-400 py-4 pb-20">æœ¬ç¶²é æ¸¬è©¦ä¸­ï¼Œå¦‚æœ‰å‹˜èª¤è«‹ä¾ç…§ç´™æœ¬èªªæ˜æœƒè³‡æ–™ç‚ºæº–<br>ç¥æ‚¨æ—…é€”æ„‰å¿« Have a Nice Trip</div>',
                '        </div>',
                '',
                '        <div id="view-info" class="hidden space-y-4 pb-10">',
                '            <!-- æœå‹™è²»å¡ç‰‡ (æ–°å¢) -->',
                '            <div class="bg-white dark:bg-jp-card-dark rounded-xl p-5 card-shadow transition-colors border-l-4 border-yellow-500">',
                '                <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-2"><i class="fas fa-hand-holding-usd text-yellow-500 mr-2"></i>æœå‹™è²»èªªæ˜</h3>',
                '                <p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed">',
                `                    æœ¬è¡Œç¨‹å°éŠå¸æ©Ÿçš„æœå‹™è²»ç‚ºï¼Œæ¯ä½æ—…å®¢æ¯å¤© <span class="font-bold text-jp-red">${data.info.tips.currency} ${data.info.tips.perDay} å…ƒ</span>ï¼Œ`,
                `                    ${data.info.tips.days} å¤©å…± <span class="font-bold text-jp-red">${data.info.tips.currency} ${totalTips} å…ƒ</span>ï¼Œ`,
                '                    è«‹ä¸€å¾‹åœ¨æ—¥æœ¬ç•¶åœ°æ”¯ä»˜çµ¦å°éŠã€‚',
                '                </p>',
                '            </div>',
                '',
                '            <div class="bg-white dark:bg-jp-card-dark rounded-xl p-5 card-shadow transition-colors">',
                '                <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-3 border-l-4 border-orange-400 pl-3">èˆªç­è³‡è¨Š</h3>',
                data.flights.map(f => `
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 mb-2">
                    <div class="flex justify-between text-sm mb-1 text-gray-600 dark:text-gray-300">
                        <span class="font-bold">${f.type} ${f.code}</span><span>${f.date}</span>
                    </div>
                    <div class="grid grid-cols-[1fr_auto_1fr] items-center text-gray-800 dark:text-white">
                        <div><div class="text-xl font-bold">${f.depTime}</div><div class="text-xs opacity-60">${f.depAirport}</div></div>
                        <div class="text-center"><i class="fas fa-arrow-right opacity-40"></i></div>
                        <div class="text-right"><div class="text-xl font-bold">${f.arrTime}</div><div class="text-xs opacity-60">${f.arrAirport}</div></div>
                    </div>
                </div>`).join(''),
                '            </div>',
                '',
                '            <div class="bg-white dark:bg-jp-card-dark rounded-xl p-5 card-shadow transition-colors">',
                '                <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-3"><i class="fas fa-hotel text-indigo-400 mr-2"></i>ä½å®¿è³‡è¨Š</h3>',
                '                <ul class="text-sm space-y-3 dark:text-gray-300">',
                data.days.map(d => `
                    <li class="flex justify-between border-b border-gray-50 dark:border-gray-700 pb-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 p-1 rounded" onclick="${d.hotelAddress ? `showHotelCard('${d.hotel}', '${d.hotelTel}', '${d.hotelAddress}', 'Day ${d.day}')` : ''}">
                        <span class="text-jp-indigo dark:text-indigo-300 font-bold">Day ${d.day} ${d.hotelAddress ? '<i class="fas fa-search-plus text-xs ml-1 opacity-50"></i>' : ''}</span>
                        <span class="font-medium text-right">${d.hotel}<br><span class="text-xs text-gray-400">${d.hotel.includes('æº«æš–çš„å®¶') ? '' : d.hotelTel || 'è©³æ´½é ˜éšŠ'}</span></span>
                    </li>`).join(''),
                '                </ul>',
                showDriverCardHint ? '<p class="text-[10px] text-gray-400 mt-2 text-right">* é»æ“Šé£¯åº—å¯é¡¯ç¤ºçµ¦å¸æ©Ÿçœ‹çš„å¡ç‰‡</p>' : '',
                '            </div>',
                '',
                '            <div class="space-y-3">',
                '                <div class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-xl">',
                '                    <i class="fas fa-sun text-orange-500 text-xl mb-2"></i>',
                '                    <h4 class="font-bold text-sm text-gray-700 dark:text-gray-200">å¤©æ°£ç©¿è‘—</h4>',
                `                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 leading-relaxed">${data.info.weather}</p>`,
                '                </div>',
                '                <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl">',
                '                    <i class="fas fa-money-bill-wave text-green-500 text-xl mb-2"></i>',
                '                    <h4 class="font-bold text-sm text-gray-700 dark:text-gray-200">è²¨å¹£åŒ¯ç‡</h4>',
                `                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 leading-relaxed">${data.info.currency}</p>`,
                '                </div>',
                '                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">',
                '                    <h4 class="font-bold text-sm text-gray-700 dark:text-gray-200 mb-1"><i class="fas fa-suitcase text-blue-500 mr-2"></i>è¡Œæèˆ‡é ˆçŸ¥</h4>',
                `                    <p class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed">${data.info.baggage}</p>`,
                '                </div>',
                '            </div>',
                '',
                imageList.length > 0 ? `
                <div class="bg-white dark:bg-jp-card-dark rounded-xl p-5 card-shadow transition-colors mt-4">
                    <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-3"><i class="fas fa-images text-pink-500 mr-2"></i>æ³¨æ„äº‹é …</h3>
                    <div class="grid grid-cols-1 gap-2">
                        ${imageList.map(url => `<img src="${url}" onerror="this.style.display='none'" class="w-full h-auto object-contain rounded-lg shadow-sm">`).join('')}
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 text-center">* è«‹è©³é–±ä»¥ä¸Šæ³¨æ„äº‹é …</p>
                </div>` : '',
                '',
                data.info.pdfPath ? `
                <a href="${data.info.pdfPath}" target="_blank" class="block w-full bg-gray-800 hover:bg-gray-700 text-white text-center py-3 rounded-xl font-bold mt-6 shadow-md transition">
                    <i class="fas fa-file-pdf mr-2"></i> ä¸‹è¼‰ç´™æœ¬èªªæ˜æœƒè³‡æ–™
                </a>` : '',
                data.info.surveyUrl ? `
                <a href="${data.info.surveyUrl}" target="_blank" class="block w-full bg-teal-600 hover:bg-teal-700 text-white text-center py-3 rounded-xl font-bold mt-6 shadow-md transition">
                    <i class="fas fa-smile mr-2"></i> å¡«å¯«å®¢æˆ¶æ»¿æ„åº¦èª¿æŸ¥
                </a>` : '',
                '            <div class="text-center text-xs text-gray-400 py-4 pb-20">æœ¬ç¶²é æ¸¬è©¦ä¸­ï¼Œå¦‚æœ‰å‹˜èª¤è«‹ä¾ç…§ç´™æœ¬èªªæ˜æœƒè³‡æ–™ç‚ºæº–<br>ç¥æ‚¨æ—…é€”æ„‰å¿« Have a Nice Trip</div>',
                '        </div>',
                '',
                '        <div id="view-tools" class="hidden space-y-6 pb-10">',
                '            ',
                '            <div class="bg-white dark:bg-jp-card-dark rounded-xl p-5 card-shadow transition-colors">',
                '                <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-3"><i class="fas fa-tasks text-teal-500 mr-2"></i>æ—…äººæª¢æŸ¥æ¸…å–®</h3>',
                '                <div class="space-y-4">',
                '                    <div>',
                '                        <p class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-300 px-2 py-1 rounded inline-block">é‡è¦æ–‡ä»¶</p>',
                '                        <div class="grid grid-cols-2 gap-2">',
                '                            <label class="flex items-center space-x-2 cursor-pointer custom-checkbox">',
                '                                <input type="checkbox" id="check_doc_passport" class="hidden" onchange="saveCheck(this.id)">',
                '                                <div class="w-4 h-4 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                                <span class="text-sm text-gray-600 dark:text-gray-300">è­·ç…§ (æª¢æŸ¥æ•ˆæœŸ)</span>',
                '                            </label>',
                '                            <label class="flex items-center space-x-2 cursor-pointer custom-checkbox">',
                '                                <input type="checkbox" id="check_doc_money" class="hidden" onchange="saveCheck(this.id)">',
                '                                <div class="w-4 h-4 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                                <span class="text-sm text-gray-600 dark:text-gray-300">æ—¥å¹£</span>',
                '                            </label>',
                '                            <label class="flex items-center space-x-2 cursor-pointer custom-checkbox">',
                '                                <input type="checkbox" id="check_doc_vjw" class="hidden" onchange="saveCheck(this.id)">',
                '                                <div class="w-4 h-4 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                                <span class="text-sm text-gray-600 dark:text-gray-300">ä¿¡ç”¨å¡</span>',
                '                            </label>',
                '                            <label class="flex items-center space-x-2 cursor-pointer custom-checkbox">',
                '                                <input type="checkbox" id="check_doc_ticket" class="hidden" onchange="saveCheck(this.id)">',
                '                                <div class="w-4 h-4 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                                <span class="text-sm text-gray-600 dark:text-gray-300">å€‹äººæ—…éŠä¿éšª</span>',
                '                            </label>',
                '                        </div>',
                '                    </div>',
                '                    <div>',
                '                        <p class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 px-2 py-1 rounded inline-block">3C ç”¢å“</p>',
                '                        <div class="grid grid-cols-2 gap-2">',
                '                            <label class="flex items-center space-x-2 cursor-pointer custom-checkbox">',
                '                                <input type="checkbox" id="check_3c_phone" class="hidden" onchange="saveCheck(this.id)">',
                '                                <div class="w-4 h-4 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                                <span class="text-sm text-gray-600 dark:text-gray-300">ç¶²å¡/æ¼«éŠ</span>',
                '                            </label>',
                '                            <label class="flex items-center space-x-2 cursor-pointer custom-checkbox">',
                '                                <input type="checkbox" id="check_3c_charge" class="hidden" onchange="saveCheck(this.id)">',
                '                                <div class="w-4 h-4 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                                <span class="text-sm text-gray-600 dark:text-gray-300">å……é›»å™¨/å……é›»ç·š</span>',
                '                            </label>',
                '                            <label class="flex items-center space-x-2 cursor-pointer custom-checkbox">',
                '                                <input type="checkbox" id="check_3c_bank" class="hidden" onchange="saveCheck(this.id)">',
                '                                <div class="w-4 h-4 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                                <span class="text-sm text-gray-600 dark:text-gray-300">è¡Œå‹•é›»æº</span>',
                '                            </label>',
                '                        </div>',
                '                        <div class="mt-2 text-[10px] text-yellow-600 bg-yellow-50 dark:bg-yellow-900/20 dark:text-yellow-400 p-2 rounded">',
                '                            âš¡ æ—¥æœ¬é›»å£“ç‚º 100Vï¼Œè«‹ç¢ºèªæ‚¨çš„é›»å™¨(å¦‚å¹é¢¨æ©Ÿ)æ˜¯å¦æ”¯æ´ï¼',
                '                        </div>',
                '                    </div>',
                '                    <div>',
                '                        <p class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-300 px-2 py-1 rounded inline-block">å€‹äºº / ç›¥æ´— / è—¥å“</p>',
                '                        <div class="grid grid-cols-2 gap-2">',
                '                            <label class="flex items-center space-x-2 cursor-pointer custom-checkbox">',
                '                                <input type="checkbox" id="check_item_rain" class="hidden" onchange="saveCheck(this.id)">',
                '                                <div class="w-4 h-4 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                                <span class="text-sm text-gray-600 dark:text-gray-300">é›¨å…·/æ‘ºç–Šå‚˜</span>',
                '                            </label>',
                '                            <label class="flex items-center space-x-2 cursor-pointer custom-checkbox">',
                '                                <input type="checkbox" id="check_item_coat" class="hidden" onchange="saveCheck(this.id)">',
                '                                <div class="w-4 h-4 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                                <span class="text-sm text-gray-600 dark:text-gray-300">å¤–å¥—/ä¿æš–è¡£ç‰©</span>',
                '                            </label>',
                '                            <label class="flex items-center space-x-2 cursor-pointer custom-checkbox">',
                '                                <input type="checkbox" id="check_item_wash" class="hidden" onchange="saveCheck(this.id)">',
                '                                <div class="w-4 h-4 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                                <span class="text-sm text-gray-600 dark:text-gray-300">ç‰™åˆ·/æ´—é¢ä¹³</span>',
                '                            </label>',
                '                            <label class="flex items-center space-x-2 cursor-pointer custom-checkbox">',
                '                                <input type="checkbox" id="check_item_meds" class="hidden" onchange="saveCheck(this.id)">',
                '                                <div class="w-4 h-4 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                                <span class="text-sm text-gray-600 dark:text-gray-300">å€‹äººå¸¸å‚™è—¥</span>',
                '                            </label>',
                '                        </div>',
                '                    </div>',
                '                </div>',
                '                <div class="mt-6 pt-4 border-t border-gray-100 dark:border-gray-700">',
                '                    <p class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider">æ¯æ—¥é€€æˆ¿æª¢æŸ¥ (é˜²æ­¢éºè½)</p>',
                '                    <div class="space-y-2">',
                '                        <label class="flex items-center space-x-3 cursor-pointer custom-checkbox">',
                '                            <input type="checkbox" id="daily_charger" class="hidden" onchange="saveCheck(this.id)">',
                '                            <div class="w-5 h-5 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                            <span class="text-sm text-gray-600 dark:text-gray-300">å……é›»å™¨ / è½‰æ¥é ­ / è¡Œå‹•é›»æº</span>',
                '                        </label>',
                '                        <label class="flex items-center space-x-3 cursor-pointer custom-checkbox">',
                '                            <input type="checkbox" id="daily_wash" class="hidden" onchange="saveCheck(this.id)">',
                '                            <div class="w-5 h-5 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                            <span class="text-sm text-gray-600 dark:text-gray-300">ç›¥æ´—åŒ… / çœ¼é¡ / éš±çœ¼</span>',
                '                        </label>',
                '                        <label class="flex items-center space-x-3 cursor-pointer custom-checkbox">',
                '                            <input type="checkbox" id="daily_wifi" class="hidden" onchange="saveCheck(this.id)">',
                '                            <div class="w-5 h-5 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                            <span class="text-sm text-gray-600 dark:text-gray-300">è­·ç…§ / éš¨èº«è²´é‡ç‰©å“</span>',
                '                        </label>',
                '                        <label class="flex items-center space-x-3 cursor-pointer custom-checkbox">',
                '                            <input type="checkbox" id="daily_key" class="hidden" onchange="saveCheck(this.id)">',
                '                            <div class="w-5 h-5 border-2 border-gray-300 rounded flex items-center justify-center transition-colors"></div>',
                '                            <span class="text-sm text-gray-600 dark:text-gray-300">æˆ¿å¡å·²æ­¸é‚„</span>',
                '                        </label>',
                '                    </div>',
                '                    <button onclick="resetDailyChecks()" class="mt-3 text-xs text-blue-400 underline w-full text-right">é‡ç½®æ¯æ—¥æª¢æŸ¥</button>',
                '                </div>',
                '            </div>',
                '',
                '            <!-- B. æ‰‹æŒ‡æ—¥èª -->',
                '            <div class="bg-white dark:bg-jp-card-dark rounded-xl p-5 card-shadow transition-colors">',
                '                <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-3">',
                '                    <i class="fas fa-language text-green-500 mr-2"></i>æ‰‹æŒ‡æ—¥èª',
                '                </h3>',
                '                ',
                '                <p class="text-xs text-gray-400 mb-2 mt-1 font-bold">åŸºç¤æœƒè©±</p>',
                '                <div class="grid grid-cols-2 gap-3 mb-4">',
                '                    <button onclick="speakJp(\'ã™ã¿ã¾ã›ã‚“\', \'è˜‡å’ªåª½æ£®\')" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-left active:bg-gray-200 dark:active:bg-gray-600 transition">',
                '                        <div class="text-xs text-gray-400">ä¸å¥½æ„æ€ / è«‹å•</div>',
                '                        <div class="font-bold text-jp-indigo dark:text-blue-200">Sumimasen</div>',
                '                    </button>',
                '                    <button onclick="speakJp(\'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹\', \'é€ä»¥é›·å“‡ å¤šå£çˆ¹æ€å˜\')" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-left active:bg-gray-200 dark:active:bg-gray-600 transition">',
                '                        <div class="text-xs text-gray-400">å»æ‰€åœ¨å“ªè£¡</div>',
                '                        <div class="font-bold text-jp-indigo dark:text-blue-200">Toire wa?</div>',
                '                    </button>',
                '                </div>',
                '',
                '                <p class="text-xs text-gray-400 mb-2 font-bold">ğŸ›ï¸ è³¼ç‰©çµå¸³</p>',
                '                <div class="grid grid-cols-2 gap-3 mb-4">',
                '                    <button onclick="speakJp(\'åˆ¥ã€…ã«åŒ…ã‚“ã§ãã ã•ã„\', \'è²èŒ²è²èŒ² å¦® æ­¤å¯¸çˆ¹ å“­æ­è³½\')" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-left active:bg-gray-200 dark:active:bg-gray-600 transition">',
                '                        <div class="text-xs text-gray-400">è«‹å¹«æˆ‘åˆ†é–‹åŒ…è£</div>',
                '                        <div class="font-bold text-jp-indigo dark:text-blue-200 text-sm">Betsu-betsu ni...</div>',
                '                    </button>',
                '                    <button onclick="speakJp(\'å…ç¨ã«ãªã‚Šã¾ã™ã‹\', \'éºµè³Š å¦® æ‹¿å“©åª½æ€å˜\')" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-left active:bg-gray-200 dark:active:bg-gray-600 transition">',
                '                        <div class="text-xs text-gray-400">å¯ä»¥å…ç¨…å—?</div>',
                '                        <div class="font-bold text-jp-indigo dark:text-blue-200">Tax Free?</div>',
                '                    </button>',
                '                    <button onclick="speakJp(\'è¢‹ã¯è¦ã‚Šã¾ã›ã‚“\', \'ç¦å“­æ‘Ÿ å“‡ ä»¥å“©åª½æ£®\')" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-left active:bg-gray-200 dark:active:bg-gray-600 transition">',
                '                        <div class="text-xs text-gray-400">ä¸ç”¨è¢‹å­</div>',
                '                        <div class="font-bold text-jp-indigo dark:text-blue-200">No Bag</div>',
                '                    </button>',
                '                    <button onclick="speakJp(\'æ–°ã—ã„ã®ã¯ã‚ã‚Šã¾ã™ã‹\', \'é˜¿ä»–æ‹‰ç³» è«¾å“‡ é˜¿å“©åª½æ€å˜\')" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-left active:bg-gray-200 dark:active:bg-gray-600 transition">',
                '                        <div class="text-xs text-gray-400">æœ‰æ–°çš„å—?</div>',
                '                        <div class="font-bold text-jp-indigo dark:text-blue-200">New one?</div>',
                '                    </button>',
                '                    <button onclick="speakJp(\'ã“ã‚Œã‚’ãã ã•ã„\', \'å£é›·å–” å“­æ­è³½\')" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-left active:bg-gray-200 dark:active:bg-gray-600 transition">',
                '                        <div class="text-xs text-gray-400">æˆ‘è¦é€™å€‹</div>',
                '                        <div class="font-bold text-jp-indigo dark:text-blue-200">Kore o kudasai</div>',
                '                    </button>',
                '                    <button onclick="speakJp(\'ã‚«ãƒ¼ãƒ‰ã¯ä½¿ãˆã¾ã™ã‹\', \'å¡å¤š å“‡ æ­¤å‡±åª½æ€å˜\')" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-left active:bg-gray-200 dark:active:bg-gray-600 transition">',
                '                        <div class="text-xs text-gray-400">å¯ä»¥åˆ·å¡å—?</div>',
                '                        <div class="font-bold text-jp-indigo dark:text-blue-200">Card OK?</div>',
                '                    </button>',
                '                </div>',
                '',
                '                <p class="text-xs text-gray-400 mb-2 font-bold">ğŸ½ï¸ é¤å»³ç”¨é¤</p>',
                '                <div class="grid grid-cols-2 gap-3">',
                '                    <button onclick="speakJp(\'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãã ã•ã„\', \'å¦¹ç´ å–” å“­æ­è³½\')" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-left active:bg-gray-200 dark:active:bg-gray-600 transition">',
                '                        <div class="text-xs text-gray-400">è«‹çµ¦æˆ‘èœå–®</div>',
                '                        <div class="font-bold text-jp-indigo dark:text-blue-200">Menu Please</div>',
                '                    </button>',
                '                    <button onclick="speakJp(\'ãŠæ°´ã‚’ãã ã•ã„\', \'æ­å’ªèŒ² å–” å“­æ­è³½\')" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-left active:bg-gray-200 dark:active:bg-gray-600 transition">',
                '                        <div class="text-xs text-gray-400">è«‹çµ¦æˆ‘æ°´</div>',
                '                        <div class="font-bold text-jp-indigo dark:text-blue-200">Water Please</div>',
                '                    </button>',
                '                    <button onclick="speakJp(\'ãŠã™ã™ã‚ã¯ï¼Ÿ\', \'æ­è˜‡è˜‡å¦¹ å“‡\')" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-left active:bg-gray-200 dark:active:bg-gray-600 transition">',
                '                        <div class="text-xs text-gray-400">æœ‰æ¨è–¦çš„å—?</div>',
                '                        <div class="font-bold text-jp-indigo dark:text-blue-200">Recommend?</div>',
                '                    </button>',
                '                    <button onclick="speakJp(\'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™\', \'æ­å‡±K å–”é¤’è©²ä¾å¸Œåª½æ€\')" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-left active:bg-gray-200 dark:active:bg-gray-600 transition">',
                '                        <div class="text-xs text-gray-400">éº»ç…©çµå¸³</div>',
                '                        <div class="font-bold text-jp-indigo dark:text-blue-200">Check Bill</div>',
                '                    </button>',
                '                </div>',
                '',
                '                <div id="speak-status" class="text-center text-xs text-gray-400 mt-2 h-4"></div>',
                '            </div>',
                '',
                '            <!-- D. ç·Šæ€¥è¯çµ¡ -->',
                '            <div class="bg-white dark:bg-jp-card-dark rounded-xl p-5 card-shadow transition-colors">',
                '                <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-4"><i class="fas fa-exclamation-circle text-jp-red mr-2"></i>ç·Šæ€¥è¯çµ¡ & æ”¯æ´</h3>',
                '                ',
                '                <div class="grid grid-cols-2 gap-3 mb-3">',
                '                    <a href="tel:110" class="border border-gray-200 dark:border-gray-600 rounded-xl p-3 text-center active:bg-gray-50 dark:active:bg-gray-700">',
                '                        <div class="text-xs text-gray-400 mb-1">è­¦å¯Ÿ (POLICE)</div>',
                '                        <div class="text-3xl font-bold text-jp-red">110</div>',
                '                    </a>',
                '                    <a href="tel:119" class="border border-gray-200 dark:border-gray-600 rounded-xl p-3 text-center active:bg-gray-50 dark:active:bg-gray-700">',
                '                        <div class="text-xs text-gray-400 mb-1">æ•‘è­·/ç«è­¦</div>',
                '                        <div class="text-3xl font-bold text-jp-red">119</div>',
                '                    </a>',
                '                </div>',
                '',
                '                <a href="tel:05038162787" class="block border border-gray-200 dark:border-gray-600 rounded-xl p-4 mb-4 active:bg-gray-50 dark:active:bg-gray-700">',
                '                    <div class="flex justify-between items-center">',
                '                        <div>',
                '                            <div class="font-bold text-gray-800 dark:text-gray-200">è¨ªæ—¥å¤–åœ‹äºº<br>é†«ç™‚ & æ€¥é›£ç†±ç·š</div>',
                '                            <div class="text-[10px] text-gray-400 uppercase">Japan Visitor Hotline (JNTO)</div>',
                '                            <div class="text-2xl font-bold text-gray-700 dark:text-gray-300 mt-1">050-3816-2787</div>',
                '                        </div>',
                '                        <div class="w-10 h-10 bg-gray-800 text-white rounded-full flex items-center justify-center">',
                '                            <i class="fas fa-phone"></i>',
                '                        </div>',
                '                    </div>',
                '                    <div class="text-[10px] text-gray-400 mt-2">* 24å°æ™‚å°æ‡‰ (è‹±/ä¸­/éŸ“)</div>',
                '                </a>',
                '',
                '                <div class="space-y-3 pt-3 border-t border-gray-100 dark:border-gray-700">',
                '                    <p class="text-xs text-gray-400 font-bold">åœ˜é«”å°ˆå±¬è¯çµ¡äºº</p>',
                `                    <div onclick="callGuide('${data.guide.twPhone}')" class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer">
                                        <div><p class="font-bold text-sm dark:text-gray-200">å°éŠ ${data.guide.name}</p><p class="text-xs text-gray-400">${data.guide.twPhone}</p></div>
                                        <div class="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center"><i class="fas fa-phone"></i></div>
                                    </div>`,
                `                    <a href="tel:${data.meeting.airportStaff ? data.meeting.airportStaff.split(' ').pop() : ''}" class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div><p class="font-bold text-sm dark:text-gray-200">æ©Ÿå ´å°ˆå“¡</p><p class="text-xs text-gray-400">${data.meeting.airportStaff || 'ç„¡è³‡è¨Š'}</p></div>
                                        <div class="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center"><i class="fas fa-phone"></i></div>
                                    </a>`,
                '                    <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-100 dark:border-red-900">',
                '                        <p class="text-xs text-jp-red dark:text-red-400 font-bold mb-1">å¤–äº¤éƒ¨ æ±äº¬é§æ—¥ä»£è¡¨è™•</p>',
                '                        <a href="tel:+81332807917" class="block text-sm text-gray-700 dark:text-gray-300 mb-1">03-3280-7917 (ä¸Šç­æ™‚é–“)</a>',
                '                        <a href="tel:+818010097179" class="block text-sm font-bold text-red-600">080-1009-7179 (æ€¥é›£æ•‘åŠ©)</a>',
                '                    </div>',
                '                </div>',
                '            </div>',
                '',
                '            <!-- F. åŒ¯ç‡æ›ç®— -->',
                '            <div class="bg-white dark:bg-jp-card-dark rounded-xl p-5 card-shadow transition-colors">',
                '                <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-3"><i class="fas fa-coins text-yellow-500 mr-2"></i>å³æ™‚åŒ¯ç‡æ›ç®—</h3>',
                '                <div class="flex items-center space-x-2 bg-gray-50 dark:bg-gray-700 p-4 rounded-xl">',
                '                    <div class="flex-1"><label class="text-xs text-gray-400 block mb-1">æ—¥å¹£ (JPY)</label><input type="number" id="calc-jpy" placeholder="è¼¸å…¥" class="w-full bg-transparent text-xl font-bold text-gray-700 dark:text-white outline-none" oninput="convertCurrency()"></div>',
                '                    <i class="fas fa-arrow-right text-gray-300"></i>',
                '                    <div class="flex-1 text-right"><label class="text-xs text-gray-400 block mb-1">å°å¹£ (TWD)</label><div id="calc-twd" class="text-xl font-bold text-blue-500">0</div></div>',
                '                </div>',
                '                <p class="text-[10px] text-gray-400 mt-2 text-right">åŒ¯ç‡åƒè€ƒ: 1 JPY â‰ˆ <span id="calc-rate-display">...</span> TWD</p>',
                '            </div>',
                '',
                '            <!-- G. å…ç¨…æ¹Šå–® -->',
                '            <div class="bg-white dark:bg-jp-card-dark rounded-xl p-5 card-shadow transition-colors">',
                '                <div class="flex justify-between items-center mb-3">',
                '                    <h3 class="font-bold text-gray-800 dark:text-gray-100"><i class="fas fa-calculator text-pink-500 mr-2"></i>å…ç¨…æ¹Šå–®è¨ˆç®—æ©Ÿ</h3>',
                '                    <button onclick="resetBatch()" class="text-xs text-red-400 underline">é‡ç½®</button>',
                '                </div>',
                '                <div class="bg-pink-50 dark:bg-pink-900/10 p-4 rounded-xl border border-pink-100 dark:border-pink-900/30">',
                '                    <div class="mb-3">',
                '                         <input type="text" id="batch-store-name" placeholder="å•†åº—åç¨± (ä¾‹: æ¾æœ¬æ¸…)" class="w-full bg-white dark:bg-gray-700 dark:text-white border border-pink-200 dark:border-gray-600 rounded-lg text-sm px-3 py-2 outline-none mb-2 transition-opacity">',
                '                         <div class="flex gap-1">',
                '                             <input type="text" id="batch-item-name" placeholder="å“é …" class="flex-[2] min-w-0 bg-white dark:bg-gray-700 dark:text-white border border-pink-200 dark:border-gray-600 rounded-lg text-sm px-2 py-2 outline-none">',
                '                             <input type="number" id="batch-item-qty" placeholder="x1" class="w-12 bg-white dark:bg-gray-700 dark:text-white border border-pink-200 dark:border-gray-600 rounded-lg text-sm px-1 py-2 outline-none text-center">',
                '                             <input type="number" id="batch-item-price" placeholder="Â¥å–®åƒ¹" class="w-20 bg-white dark:bg-gray-700 dark:text-white border border-pink-200 dark:border-gray-600 rounded-lg text-sm px-2 py-2 outline-none">',
                '                             <button onclick="addBatchItem()" class="bg-pink-500 text-white rounded-lg px-3 py-2"><i class="fas fa-plus"></i></button>',
                '                         </div>',
                '                    </div>',
                '                    ',
                '                    <ul id="batch-list" class="space-y-1 text-xs text-gray-600 dark:text-gray-400 mb-3 max-h-24 overflow-y-auto"></ul>',
                '',
                '                    <div class="border-t border-pink-200 dark:border-pink-900/30 pt-2">',
                '                        <div class="flex justify-between text-xs mb-1">',
                '                            <span class="text-gray-500 dark:text-gray-400">ç›®å‰ç¸½è¨ˆ</span>',
                '                            <span id="batch-total-display" class="font-bold text-gray-800 dark:text-white">Â¥0</span>',
                '                        </div>',
                '                        <div class="flex justify-between text-xs mb-2">',
                '                             <span id="batch-status-text" class="text-jp-red font-bold">é‚„å·® Â¥5,500</span>',
                '                        </div>',
                '                        <div class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-600 mb-3">',
                '                            <div id="batch-progress" class="bg-jp-red h-3 rounded-full transition-all duration-500" style="width: 0%"></div>',
                '                        </div>',
                '                        <button onclick="saveBatchToMain()" class="w-full bg-jp-indigo hover:bg-blue-800 text-white text-xs py-2 rounded-lg transition shadow-sm">',
                '                            <i class="fas fa-save mr-1"></i> çµç®—ä¸¦å„²å­˜è‡³è³¼ç‰©ç´€éŒ„',
                '                        </button>',
                '                    </div>',
                '                </div>',
                '            </div>',
                '',
                '            <!-- H. è³¼ç‰©è¨˜å¸³ -->',
                '            <div class="bg-white dark:bg-jp-card-dark rounded-xl p-5 card-shadow transition-colors">',
                '                <div class="flex justify-between items-center mb-3"><h3 class="font-bold text-gray-800 dark:text-gray-100"><i class="fas fa-shopping-bag text-yellow-400 mr-2"></i>è³¼ç‰©è¨˜å¸³ (ç¸½è¡¨)</h3><button onclick="resetBudget()" class="text-xs text-red-400 underline">é‡ç½®</button></div>',
                '                ',
                '                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl mb-4 text-center">',
                '                    <p class="text-xs text-gray-400">ç¸½èŠ±è²» (JPY)</p><p class="text-3xl font-bold text-gray-800 dark:text-white" id="total-amount">Â¥0</p>',
                '                    <p class="text-xs text-gray-400 mt-1">ç´„å°å¹£ NT$ <span id="twd-amount">0</span></p>',
                '                </div>',
                '',
                '                <div class="flex gap-1 mb-4">',
                '                    <input type="text" id="item-name" placeholder="å–®ç­†å“é …" class="flex-[2] min-w-0 bg-gray-100 dark:bg-gray-700 dark:text-white border-none rounded-lg text-sm px-2 py-2 outline-none">',
                '                    <input type="number" id="item-qty" placeholder="x1" class="w-12 bg-gray-100 dark:bg-gray-700 dark:text-white border-none rounded-lg text-sm px-1 py-2 outline-none text-center">',
                '                    <input type="number" id="item-price" placeholder="Â¥å–®åƒ¹" class="w-20 bg-gray-100 dark:bg-gray-700 dark:text-white border-none rounded-lg text-sm px-2 py-2 outline-none">',
                '                    <button onclick="addItem()" class="bg-blue-500 text-white rounded-lg px-3 py-2"><i class="fas fa-plus"></i></button>',
                '                </div>',
                '                <ul id="budget-list" class="space-y-2 text-sm max-h-40 overflow-y-auto dark:text-gray-300"></ul>',
                '            </div>',
                '            <div class="text-center text-xs text-gray-400 py-4 pb-20">æœ¬ç¶²é æ¸¬è©¦ä¸­ï¼Œå¦‚æœ‰å‹˜èª¤è«‹ä¾ç…§ç´™æœ¬èªªæ˜æœƒè³‡æ–™ç‚ºæº–<br>ç¥æ‚¨æ—…é€”æ„‰å¿« Have a Nice Trip</div>',
                '        </div>',
                '',
                '    </main>',
                '',
                '    <!-- Modal for Hotel Card -->',
                '    <div id="hotel-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onclick="closeHotelCard()">',
                '        <div class="bg-white w-full max-w-sm rounded-2xl p-6 text-center shadow-2xl relative" onclick="event.stopPropagation()">',
                '            <button onclick="closeHotelCard()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>',
                '            <p class="text-xs text-gray-400 mb-2 uppercase tracking-widest">Driver Card</p>',
                '            <div class="border-2 border-jp-indigo p-4 rounded-xl">',
                '                <p class="text-sm text-gray-500 mb-1">æ­¤æ–¹ã¾ã§ãŠé¡˜ã„ã—ã¾ã™</p>',
                '                <h2 class="text-xl font-black text-jp-indigo mb-4 leading-relaxed" id="modal-hotel-name"></h2>',
                '                <hr class="border-dashed border-gray-300 my-3">',
                '                <p class="text-left text-sm font-bold text-gray-700"><span id="modal-hotel-addr"></span></p>',
                '                <p class="text-left text-xs text-gray-400 mt-1">TEL: <span id="modal-hotel-tel"></span></p>',
                '            </div>',
                '            <p class="text-xs text-gray-400 mt-4">(é»æ“ŠèƒŒæ™¯é—œé–‰)</p>',
                '        </div>',
                '    </div>',
                '',
                '    <script>',
                `        // Data Injection`,
                `        const TRIP_DATA = ${jsonStr};`,
                '',
                '        // --- UI Switching ---',
                '        function switchTab(tabName) {',
                '            [\'itinerary\', \'info\', \'tools\'].forEach(t => {',
                '                document.getElementById(\'view-\'+t).classList.add(\'hidden\');',
                '                document.getElementById(\'btn-\'+t).className = \'flex-1 py-3 text-sm tab-inactive transition-all\';',
                '            });',
                '            document.getElementById(\'view-\'+tabName).classList.remove(\'hidden\');',
                '            document.getElementById(\'btn-\'+tabName).className = \'flex-1 py-3 text-sm tab-active transition-all\';',
                '            document.getElementById(\'main-content\').scrollTop = 0;',
                '        }',
                '',
                '        // Toggle Spot Detail',
                '        function toggleDetail(el) {',
                '            const content = el.querySelector(\'.detail-content\');',
                '            const icon = el.querySelector(\'.fa-chevron-down\');',
                '            if (content) {',
                '                if (content.classList.contains(\'hidden\')) {',
                '                    content.classList.remove(\'hidden\');',
                '                    if(icon) icon.classList.add(\'rotate-180\');',
                '                } else {',
                '                    content.classList.add(\'hidden\');',
                '                    if(icon) icon.classList.remove(\'rotate-180\');',
                '                }',
                '            }',
                '        }',
                '',
                '        // --- Hotel Modal ---',
                '        function showHotelCard(name, tel, addr, dayLabel) {',
                '             if(!addr) return; // double check logic',
                '             document.getElementById(\'modal-hotel-name\').innerHTML = name.replace(/é£¯åº—/g, \'\') + \'<br><span class="text-sm font-normal text-gray-500">(\' + dayLabel + \')</span>\';',
                '             document.getElementById(\'modal-hotel-tel\').innerText = tel;',
                '             document.getElementById(\'modal-hotel-addr\').innerText = addr;',
                '             document.getElementById(\'hotel-modal\').classList.remove(\'hidden\');',
                '        }',
                '        function closeHotelCard() { document.getElementById(\'hotel-modal\').classList.add(\'hidden\'); }',
                '',
                '        // --- Weather Logic ---',
                '        // Global resize observer variable',
                '        let headerResizeObserver = null;',
                '',
                '        async function fetchWeather() {',
                '            try {',
                '                // Initialize dynamic padding logic when weather starts fetching',
                '                initDynamicPadding();',
                '',
                '                // Geolocation logic is independent',
                '                if (navigator.geolocation) {',
                '                    navigator.geolocation.getCurrentPosition(',
                '                        async (p) => {',
                '                             try {',
                '                                 const res = await fetch(\`https://api.open-meteo.com/v1/forecast?latitude=\${p.coords.latitude}&longitude=\${p.coords.longitude}&current=temperature_2m&timezone=Asia%2FTokyo\`);',
                '                                 const d = await res.json();',
                '                                 if(d.current) document.getElementById(\'header-weather\').innerHTML = \`\${Math.round(d.current.temperature_2m)}<span class="text-sm">Â°C</span>\`;',
                '                                 document.getElementById(\'location-label\').innerHTML = \'<i class="fas fa-map-marker-alt mr-1"></i>æ‰€åœ¨åœ°å³æ™‚\';',
                '                             } catch(e){}',
                '                        }',
                '                    );',
                '                }',
                '',
                '                // Date Check for Forecast',
                '                const now = new Date();',
                '                // Reset time to start of day for comparison',
                '                now.setHours(0,0,0,0);',
                '                ',
                '                const tripDate = new Date(TRIP_DATA.meeting.date);',
                '                tripDate.setHours(0,0,0,0);',
                '                // Show from 1 day before trip',
                '                tripDate.setDate(tripDate.getDate() - 1);',
                '                ',
                '                // If today is earlier than (tripDate - 1 day), do not show forecast',
                '                if (now < tripDate) {',
                '                     TRIP_DATA.days.forEach((_, idx) => {',
                '                         const el = document.getElementById(\'weather-stats-\'+idx);',
                '                         if(el) el.innerHTML = \'<span class="text-xs text-gray-400">å¤©æ°£é å ±å°‡æ–¼å‡ºç™¼å‰1å¤©é¡¯ç¤º</span>\';',
                '                     });',
                '                     return;',
                '                }',
                '            } catch(e){}',
                '',
                '            TRIP_DATA.days.forEach(async (day, idx) => {',
                '                if(!day.lat) return;',
                '                try {',
                '                    // Basic Weather + UV + WeatherCode',
                '                    const res = await fetch(\`https://api.open-meteo.com/v1/forecast?latitude=\${day.lat}&longitude=\${day.lon}&daily=precipitation_probability_max,temperature_2m_max,temperature_2m_min,uv_index_max,weather_code&timezone=Asia%2FTokyo&forecast_days=1\`);',
                '                    const d = await res.json();',
                '                    ',
                '                    // AQI',
                '                    let aqi = \'-\';',
                '                    try {',
                '                        const aqiRes = await fetch(\`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=\${day.lat}&longitude=\${day.lon}&daily=us_aqi_max&timezone=Asia%2FTokyo&forecast_days=1\`);',
                '                        const aqiData = await aqiRes.json();',
                '                        if (aqiData.daily && aqiData.daily.us_aqi_max) {',
                '                            aqi = aqiData.daily.us_aqi_max[0];',
                '                        }',
                '                    } catch (aqiErr) {',
                '                        console.log("AQI Fetch Error", aqiErr);',
                '                    }',
                '',
                '                    if(d.daily) {',
                '                        const rain = d.daily.precipitation_probability_max[0];',
                '                        const max = Math.round(d.daily.temperature_2m_max[0]);',
                '                        const min = Math.round(d.daily.temperature_2m_min[0]);',
                '                        const uv = d.daily.uv_index_max[0];',
                '                        const wCode = d.daily.weather_code[0];',
                '',
                '                        let aqiColor = "text-green-500";',
                '                        if(aqi > 50) aqiColor = "text-yellow-500";',
                '                        if(aqi > 100) aqiColor = "text-orange-500";',
                '                        if(aqi > 150) aqiColor = "text-red-500";',
                '',
                '                        const html = \`',
                '                            <div class="flex gap-3 text-xs w-full">',
                '                                <div class="flex items-center gap-1"><span class="text-red-400 font-bold">æœ€é«˜</span> \${max}Â°</div>',
                '                                <div class="flex items-center gap-1"><span class="text-blue-400 font-bold">æœ€ä½</span> \${min}Â°</div>',
                '                                <div class="flex items-center gap-1"><i class="fas fa-umbrella text-blue-300"></i> \${rain}%</div>',
                '                            </div>',
                '                            <div class="flex gap-3 text-[10px] w-full mt-1 opacity-80">',
                '                                <div><i class="fas fa-sun text-orange-400"></i> UV: \${uv}</div>',
                '                                <div class="\${aqiColor} font-bold"><i class="fas fa-wind"></i> AQI: \${aqi}</div>',
                '                            </div>\`;',
                '                        ',
                '                        document.getElementById(\'weather-stats-\'+idx).innerHTML = html;',
                '                        ',
                '                        // Dynamic Weather Icon Logic',
                '                        let wIcon = \'<i class="fas fa-sun text-orange-400"></i>\'; // Default',
                '                        if (wCode >= 1 && wCode <= 3) wIcon = \'<i class="fas fa-cloud-sun text-gray-400"></i>\';',
                '                        else if (wCode >= 45 && wCode <= 48) wIcon = \'<i class="fas fa-smog text-gray-500"></i>\';',
                '                        else if (wCode >= 51 && wCode <= 67) wIcon = \'<i class="fas fa-cloud-rain text-blue-400"></i>\';',
                '                        else if (wCode >= 71 && wCode <= 77) wIcon = \'<i class="fas fa-snowflake text-blue-300"></i>\';',
                '                        else if (wCode >= 80 && wCode <= 82) wIcon = \'<i class="fas fa-cloud-showers-heavy text-blue-500"></i>\';',
                '                        else if (wCode >= 95) wIcon = \'<i class="fas fa-bolt text-yellow-500"></i>\';',
                '',
                '                        document.getElementById(\'weather-icon-\'+idx).innerHTML = wIcon;',
                '                    }',
                '                } catch(e){ console.error(e); }',
                '            });',
                '        }',
                '',
                '        // --- Dynamic Padding Logic ---',
                '        function initDynamicPadding() {',
                '            const header = document.getElementById(\'app-header\');',
                '            const main = document.getElementById(\'main-content\');',
                '            if (!header || !main) return;',
                '',
                '            const updatePadding = () => {',
                '                const height = header.offsetHeight;',
                '                main.style.paddingTop = (height + 15) + \'px\'; // Add a little buffer',
                '            };',
                '',
                '            // Initial update',
                '            updatePadding();',
                '',
                '            // Clean up previous observer if exists',
                '            if (headerResizeObserver) {',
                '                headerResizeObserver.disconnect();',
                '            }',
                '',
                '            // Create new observer',
                '            headerResizeObserver = new ResizeObserver(updatePadding);',
                '            headerResizeObserver.observe(header);',
                '            ',
                '            // Also update on window resize',
                '            window.addEventListener(\'resize\', updatePadding);',
                '        }',
                '',
                '        // --- Checklist Logic ---',
                '        function initChecklist() {',
                '            document.querySelectorAll(\'input[type="checkbox"]\').forEach(el => {',
                '                if(localStorage.getItem(el.id) === \'true\') el.checked = true;',
                '            });',
                '        }',
                '        function saveCheck(id) {',
                '            localStorage.setItem(id, document.getElementById(id).checked);',
                '        }',
                '        function resetDailyChecks() {',
                '            document.querySelectorAll(\'input[type="checkbox"][id^="daily_"]\').forEach(chk => {',
                '                chk.checked = false;',
                '                localStorage.setItem(chk.id, \'false\');',
                '            });',
                '            alert(\'æ¯æ—¥æª¢æŸ¥æ¸…å–®å·²é‡ç½®ï¼\');',
                '        }',
                '',
                '        // --- Currency Logic ---',
                '        let currentRate = 0.22;',
                '        async function fetchRate() {',
                '            try {',
                '                const res = await fetch(\'https://api.exchangerate-api.com/v4/latest/JPY\');',
                '                const data = await res.json();',
                '                if(data.rates.TWD) {',
                '                    currentRate = data.rates.TWD;',
                '                    document.getElementById(\'calc-rate-display\').innerText = currentRate.toFixed(3);',
                '                    renderBudget();',
                '                    convertCurrency();',
                '                }',
                '            } catch(e){}',
                '        }',
                '        function convertCurrency() {',
                '            const jpy = parseFloat(document.getElementById(\'calc-jpy\').value);',
                '            if(!isNaN(jpy)) {',
                '                document.getElementById(\'calc-twd\').innerText = Math.round(jpy * currentRate).toLocaleString();',
                '            } else {',
                '                document.getElementById(\'calc-twd\').innerText = \'0\';',
                '            }',
                '        }',
                '',
                '        // --- Budget & Batch Logic ---',
                '        let items = [];',
                '        let batchItems = [];',
                '        try { const saved = localStorage.getItem(\'trip_budget\'); if (saved) items = JSON.parse(saved); } catch (e) {}',
                '',
                '        function getIntVal(id, def = 1) {',
                '            const val = document.getElementById(id).value;',
                '            return val ? parseInt(val) : def;',
                '        }',
                '',
                '        function addBatchItem() {',
                '            const name = document.getElementById(\'batch-item-name\').value;',
                '            const price = parseInt(document.getElementById(\'batch-item-price\').value);',
                '            const qty = getIntVal(\'batch-item-qty\', 1);',
                '            ',
                '            if (name && price) {',
                '                batchItems.push({ name, price, qty });',
                '                document.getElementById(\'batch-item-name\').value = \'\';',
                '                document.getElementById(\'batch-item-price\').value = \'\';',
                '                document.getElementById(\'batch-item-qty\').value = \'\';',
                '                ',
                '                // Lock store name',
                '                const storeInput = document.getElementById(\'batch-store-name\');',
                '                storeInput.disabled = true;',
                '                storeInput.classList.add(\'opacity-50\', \'cursor-not-allowed\');',
                '                renderBatch();',
                '            }',
                '        }',
                '',
                '        function renderBatch() {',
                '            const list = document.getElementById(\'batch-list\');',
                '            const totalEl = document.getElementById(\'batch-total-display\');',
                '            const statusEl = document.getElementById(\'batch-status-text\');',
                '            const progressEl = document.getElementById(\'batch-progress\');',
                '            ',
                '            list.innerHTML = \'\';',
                '            let batchTotal = 0;',
                '            batchItems.forEach(item => {',
                '                const rowTotal = item.price * item.qty;',
                '                batchTotal += rowTotal;',
                '                list.innerHTML += \`<li class="flex justify-between"><span>\${item.name} <span class="text-xs text-gray-400">x\${item.qty}</span></span><span>Â¥\${rowTotal}</span></li>\`;',
                '            });',
                '            ',
                '            totalEl.innerText = \'Â¥\' + batchTotal.toLocaleString();',
                '            const limit = 5500;',
                '            const progress = Math.min((batchTotal / limit) * 100, 100);',
                '            const remaining = limit - batchTotal;',
                '            progressEl.style.width = \`\${progress}%\`;',
                '            ',
                '            if (batchTotal >= limit) {',
                '                statusEl.innerHTML = \'<i class="fas fa-check-circle"></i> å·²é”æ¨™ï¼å¯é€€ç¨…\';',
                '                statusEl.className = "text-green-500 font-bold text-xs mb-2";',
                '                progressEl.classList.remove(\'bg-jp-red\');',
                '                progressEl.classList.add(\'bg-green-500\');',
                '            } else {',
                '                statusEl.innerHTML = \`é‚„å·® Â¥\${remaining.toLocaleString()}\`;',
                '                statusEl.className = "text-jp-red font-bold text-xs mb-2";',
                '                progressEl.classList.remove(\'bg-green-500\');',
                '                progressEl.classList.add(\'bg-jp-red\');',
                '            }',
                '        }',
                '',
                '        function saveBatchToMain() {',
                '            if(batchItems.length === 0) return;',
                '            const storeName = document.getElementById(\'batch-store-name\').value || \'æœªåˆ†é¡å•†åº—\';',
                '            if(confirm(\`å°‡é€™ \${batchItems.length} ç­†è³‡æ–™å­˜å…¥è³¼ç‰©ç´€éŒ„ï¼Ÿ\`)) {',
                '                batchItems.forEach(item => {',
                '                    items.push({',
                '                        name: \`[\${storeName}] \${item.name}\`,',
                '                        price: item.price,',
                '                        qty: item.qty',
                '                    });',
                '                });',
                '                resetBatchInternal();',
                '                renderBudget();',
                '                alert(\'å·²å­˜å…¥ï¼\');',
                '            }',
                '        }',
                '        ',
                '        function resetBatch() {',
                '            if(batchItems.length > 0 && confirm(\'æ¸…ç©ºæ¹Šå–®è¨ˆç®—ï¼Ÿ\')) resetBatchInternal();',
                '        }',
                '        function resetBatchInternal() {',
                '            batchItems = [];',
                '            const storeInput = document.getElementById(\'batch-store-name\');',
                '            storeInput.value = \'\';',
                '            storeInput.disabled = false;',
                '            storeInput.classList.remove(\'opacity-50\', \'cursor-not-allowed\');',
                '            renderBatch();',
                '        }',
                '',
                '        // --- Main Budget Logic ---',
                '        function renderBudget() {',
                '            const list = document.getElementById(\'budget-list\');',
                '            if(!list) return;',
                '            list.innerHTML = \'\'; let total = 0;',
                '            items.forEach((item, index) => {',
                '                const qty = item.qty || 1;',
                '                const rowTotal = item.price * qty;',
                '                total += rowTotal;',
                '                list.innerHTML += \`<li class="flex justify-between items-center border-b border-gray-50 dark:border-gray-700 pb-1">',
                '                    <span class="text-gray-600 dark:text-gray-300">\${item.name} <span class="text-xs text-gray-400">x\${qty}</span></span>',
                '                    <div class="flex items-center gap-2">',
                '                        <span class="font-medium text-gray-800 dark:text-gray-200">Â¥\${rowTotal}</span>',
                '                        <button onclick="deleteItem(\${index})" class="text-gray-300 hover:text-red-400"><i class="fas fa-times"></i></button>',
                '                    </div>',
                '                </li>\`;',
                '            });',
                '            document.getElementById(\'total-amount\').innerText = \'Â¥\' + total.toLocaleString();',
                '            document.getElementById(\'twd-amount\').innerText = Math.round(total * currentRate).toLocaleString();',
                '            try { localStorage.setItem(\'trip_budget\', JSON.stringify(items)); } catch(e) {}',
                '        }',
                '        function addItem() {',
                '            const name = document.getElementById(\'item-name\').value;',
                '            const price = parseInt(document.getElementById(\'item-price\').value);',
                '            const qty = getIntVal(\'item-qty\', 1);',
                '            if (name && price) { ',
                '                items.push({ name, price, qty }); ',
                '                document.getElementById(\'item-name\').value = \'\'; ',
                '                document.getElementById(\'item-price\').value = \'\'; ',
                '                document.getElementById(\'item-qty\').value = \'\'; ',
                '                renderBudget(); ',
                '            }',
                '        }',
                '        function deleteItem(idx) { items.splice(idx, 1); renderBudget(); }',
                '        function resetBudget() { if(confirm(\'æ¸…ç©ºè¨˜å¸³ï¼Ÿ\')) { items = []; renderBudget(); } }',
                '',
                '        // --- Speech ---',
                '        function speakJp(text, romaji) {',
                '            if (\'speechSynthesis\' in window) {',
                '                const u = new SpeechSynthesisUtterance(text);',
                '                u.lang = \'ja-JP\';',
                '                u.rate = 0.9;',
                '                document.getElementById(\'speak-status\').innerText = \`ğŸ”Š æ’­æ”¾ä¸­: \${romaji}\`;',
                '                u.onend = function() { document.getElementById(\'speak-status\').innerText = \'\'; };',
                '                window.speechSynthesis.speak(u);',
                '            }',
                '        }',
                '',
                '        function callGuide(phone) {',
                '            alert("å¦‚æœå°éŠæ²’æœ‰æ¥è½ï¼Œå¯èƒ½æ˜¯åœ¨æ—¥æœ¬å¸¶åœ˜ä¸­ï¼Œè«‹è¦‹è«’ã€‚\\n\\nå› å°éŠé€šå¸¸åœ¨å‡ºç™¼å‰1å¤©æ‰æœƒæ‹¿åˆ°æ—…å®¢è³‡æ–™ï¼Œå¦‚æœæ‚¨æœ‰æƒ³è©¢å•çš„äº‹é …ï¼Œå»ºè­°åœ¨å‡ºç™¼å‰ä¸€å¤©åœ¨è©¢å•å°éŠï¼Œæœƒæ¯”è¼ƒèƒ½æä¾›å”åŠ©ã€‚\\n\\nå¦‚æƒ³å…ˆè©¢å•å¯ä»¥æ´½è©¢æ‚¨çš„æ¥­å‹™ã€‚");',
                '            window.location.href = \'tel:\' + phone;',
                '        }',
                '',
                '        // Init',
                '        fetchWeather();',
                '        fetchRate();',
                '        initChecklist();',
                '        renderBudget();',
                '',
                '    <\/script>',
                '</body>',
                '</html>'
            ];

            return htmlParts.join('\n');
        }

        const GeneratorApp = () => {
            const [data, setData] = useState(DEFAULT_DATA);
            const [status, setStatus] = useState("");
            
            // New state for PDF URLs and Tab Navigation
            const [summaryPdfUrl, setSummaryPdfUrl] = useState(null);
            const [detailPdfUrl, setDetailPdfUrl] = useState(null);
            const [rightTab, setRightTab] = useState('preview'); // 'preview', 'summary', 'detail'

            const updateData = (field, value) => setData(prev => ({ ...prev, [field]: value }));
            const updateInfo = (field, value) => setData(prev => ({ ...prev, info: { ...prev.info, [field]: value } }));
            
            // Flight Updater
            const updateFlight = (idx, field, value) => {
                const newF = [...data.flights];
                newF[idx][field] = value;
                setData(prev => ({ ...prev, flights: newF }));
            };

            const updateDay = (idx, field, value) => {
                const newDays = [...data.days];
                if(field === 'meals') {
                    newDays[idx].meals = { ...newDays[idx].meals, ...value };
                } else {
                    newDays[idx][field] = value;
                }
                
                if(field === 'location' && CITIES[value]) {
                    newDays[idx].lat = CITIES[value].lat;
                    newDays[idx].lon = CITIES[value].lon;
                }
                setData({ ...data, days: newDays });
            };

            const updateDaySpot = (dayIdx, spotIdx, field, value) => {
                const newDays = [...data.days];
                newDays[dayIdx].spots[spotIdx][field] = value;
                setData({ ...data, days: newDays });
            };

            const addSpot = (dayIdx) => {
                const newDays = [...data.days];
                newDays[dayIdx].spots.push({ name: "æ–°æ™¯é»", desc: "è«‹è¼¸å…¥ä»‹ç´¹" });
                setData({ ...data, days: newDays });
            };

            const removeSpot = (dayIdx, spotIdx) => {
                const newDays = [...data.days];
                newDays[dayIdx].spots.splice(spotIdx, 1);
                setData({ ...data, days: newDays });
            };
            
            const addDay = () => {
                const newDays = [...data.days];
                const nextDayNum = newDays.length + 1;
                newDays.push({
                    day: nextDayNum,
                    date: "",
                    location: "æ±äº¬",
                    lat: 35.68, lon: 139.76,
                    spots: [],
                    meals: { b: "", l: "", d: "" },
                    hotel: "",
                    hotelTel: "",
                    hotelAddress: ""
                });
                setData({ ...data, days: newDays });
            };

            const removeDay = (idx) => {
                if (data.days.length <= 1) return;
                if (confirm(`ç¢ºå®šåˆªé™¤ Day ${data.days[idx].day}?`)) {
                    const newDays = data.days.filter((_, i) => i !== idx).map((d, i) => ({ ...d, day: i + 1 }));
                    setData({ ...data, days: newDays });
                }
            };

            // 1. ç°¡è¡¨ PDF è§£æ
            const handleSummaryPdf = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                
                // Store Blob URL for preview
                const url = URL.createObjectURL(file);
                setSummaryPdfUrl(url);
                setRightTab('summary'); // Switch tab automatically

                setStatus("è§£æç¸½è¡¨ PDF...");
                
                const ab = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(ab).promise;
                let fullText = "";
                
                // Extract text from all pages
                for(let i=1; i<=pdf.numPages; i++) {
                    const p = await pdf.getPage(i);
                    const t = await p.getTextContent();
                    fullText += t.items.map(s => s.str).join(" ") + "\n"; 
                }

                const newData = {...data};

                // 1. Basic Info
                const codeMatch = fullText.match(/åœ˜é«”ç·¨è™Ÿ[:ï¼š\s]*([A-Z0-9]+)/);
                if(codeMatch) newData.tripCode = codeMatch[1].trim();

                const nameMatch = fullText.match(/åœ˜é«”åç¨±[:ï¼š\s]*([^\n]+)/); 
                if(nameMatch) newData.tripName = nameMatch[1].trim();

                const guideMatch = fullText.match(/é ˜éšŠå§“å[:ï¼š\s]*([^\s\n\*]+)/);
                if(guideMatch) newData.guide.name = guideMatch[1].replace(/[\u3000\sã€Œ]/g, '').trim();

                const phoneMatch = fullText.match(/å°ç£æ‰‹æ©Ÿ[:ï¼š\s]*([\d-]+)/);
                if(phoneMatch) newData.guide.twPhone = phoneMatch[1].trim();
                
                // å‡ºç™¼æ—¥æœŸè¾¨è­˜ä¿®æ­£ï¼šå„ªå…ˆæŠ“å–ã€Œå‡ºç™¼æ—¥æœŸã€å¾Œé¢çš„æ—¥æœŸ
                const departDateRegex = /å‡ºç™¼æ—¥æœŸ[:ï¼š\s]*(\d{4}\/\d{2}\/\d{2})/;
                const departDateMatch = fullText.match(departDateRegex);
                if(departDateMatch) newData.dateRange = departDateMatch[1].trim();

                // Meeting
                const meetDateMatch = fullText.match(/é›†åˆæ™‚é–“[:ï¼š\s]*(\d{4}\/\d{2}\/\d{2})/);
                const meetTimeMatch = fullText.match(/é›†åˆæ™‚é–“[:ï¼š\s]*\d{4}\/\d{2}\/\d{2}\s*(\d{2}:\d{2})/);
                if(meetDateMatch) newData.meeting.date = meetDateMatch[1];
                if(meetTimeMatch) newData.meeting.time = meetTimeMatch[1];
                
                // é›†åˆåœ°é»ä¿®æ­£
                const locRegex = /é›†åˆåœ°é»[:ï¼š\s]*([\s\S]*?)(?=\n|è­˜åˆ¥ç‰Œ|æ©Ÿå ´å°ˆå“¡|ç­æ©Ÿæ™‚åˆ»|$)/;
                const locMatch = fullText.match(locRegex);
                if(locMatch) newData.meeting.location = locMatch[1].trim();

                // è­˜åˆ¥ç‰Œä¿®æ­£ (æŠ“å–æ‹¬è™Ÿå…§çš„é¡è‰²æˆ–æ•´æ®µ)
                const badgeRegex = /è­˜åˆ¥ç‰Œ[:ï¼š\s]*([^\*]+)/;
                const badgeMatch = fullText.match(badgeRegex);
                if(badgeMatch) newData.meeting.badge = badgeMatch[1].trim();
                
                // æ©Ÿå ´å°ˆå“¡é›»è©±è¾¨è­˜ä¿®æ­£ï¼šæŠ“å–åŒ…å«é›»è©±çš„æ•´è¡Œè³‡è¨Š
                const staffRegex = /æ©Ÿå ´å°ˆå“¡[:ï¼š\s]*([^\n]+?[\d-]+)/;
                const staffMatch = fullText.match(staffRegex);
                if(staffMatch) newData.meeting.airportStaff = staffMatch[1].trim();

                // 2. Flights - ä¿®æ­£ç­æ©Ÿè³‡è¨Šè§£æ
                const flightRegex = /"(\d{4}\/\d{2}\/\d{2})"\s*,\s*"([A-Z0-9]+)"\s*,\s*"([A-Z]{3})"\s*,\s*"([A-Z]{3})"\s*,\s*"(\d{2}:\d{2})"\s*,\s*"(\d{2}:\d{2})"/g;
                const flightsFound = [...fullText.matchAll(flightRegex)];

                // å¦‚æœç”¨ä¸Šé¢çš„æ­£è¦è¡¨ç¤ºå¼æ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¦ä¸€ç¨®æ ¼å¼ (ç„¡å¼•è™Ÿ)
                if (flightsFound.length === 0) {
                     const flightRegexAlt = /(\d{4}\/\d{2}\/\d{2})\s+([A-Z0-9]+)\s+([A-Z]{3})\s+([A-Z]{3})\s+(\d{2}:\d{2})\s+(\d{2}:\d{2})/g;
                     const flightsFoundAlt = [...fullText.matchAll(flightRegexAlt)];
                     if(flightsFoundAlt.length > 0) {
                        flightsFound.push(...flightsFoundAlt);
                     }
                }

                if(flightsFound.length > 0) {
                    // Departure
                    const dep = flightsFound[0];
                    newData.flights[0] = {
                        type: "å»ç¨‹",
                        airline: getAirlineName(dep[2]), 
                        code: dep[2],
                        date: dep[1].slice(5), 
                        depTime: dep[5],
                        depAirport: dep[3], 
                        arrTime: dep[6],
                        arrAirport: dep[4]
                    };

                    if(flightsFound.length > 1) {
                        // Return
                        const ret = flightsFound[1];
                        newData.flights[1] = {
                            type: "å›ç¨‹",
                            airline: getAirlineName(ret[2]),
                            code: ret[2],
                            date: ret[1].slice(5),
                            depTime: ret[5],
                            depAirport: ret[3], 
                            arrTime: ret[6],
                            arrAirport: ret[4] 
                        };
                    }
                }

                // 3. Hotels & Itinerary - ä¿®æ­£ä½å®¿è³‡è¨Šè§£æ
                // å˜—è©¦æŠ“å–åŒ…å«é›»è©±è™Ÿç¢¼çš„è¡Œï¼Œä¸¦å‡è¨­è©²è¡ŒåŒ…å«é£¯åº—åç¨±
                const lines = fullText.split('\n');
                let currentDayIndex = 0;
                
                for(let i=0; i<lines.length; i++) {
                    const line = lines[i];
                    // å°‹æ‰¾é›»è©±è™Ÿç¢¼æ ¼å¼
                    const telMatch = line.match(/(\d{2,4}-\d{2,4}-\d{4})/);
                    
                    if(telMatch) {
                         // æ’é™¤é ˜éšŠé›»è©±ã€æ©Ÿå ´å°ˆå“¡é›»è©±
                        if (line.includes("å°ç£æ‰‹æ©Ÿ") || line.includes("æ—¥æœ¬æ‰‹æ©Ÿ") || line.includes("æ©Ÿå ´å°ˆå“¡")) {
                            continue;
                        }

                        const tel = telMatch[1];
                        // ç°¡å–®è™•ç†ï¼šç§»é™¤é›»è©±è™Ÿç¢¼å’Œå¯èƒ½çš„å¼•è™Ÿï¼Œå‰©ä¸‹çš„ç•¶ä½œé£¯åº—åç¨±
                        let hotelName = line.replace(tel, '').replace(/[",]/g, '').trim();
                        
                        if(hotelName && currentDayIndex < newData.days.length) {
                            newData.days[currentDayIndex].hotel = hotelName;
                            newData.days[currentDayIndex].hotelTel = tel;
                            currentDayIndex++;
                        }
                    }
                }

                setData(newData);
                setStatus("ç¸½è¡¨è§£æå®Œæˆï¼Œè«‹æª¢æŸ¥å…§å®¹");
            };
            
            // Helper for airline
            function getAirlineName(code) {
                if(code.startsWith('JX')) return 'æ˜Ÿå®‡èˆªç©º';
                if(code.startsWith('BR')) return 'é•·æ¦®èˆªç©º';
                if(code.startsWith('CI')) return 'ä¸­è¯èˆªç©º';
                if(code.startsWith('IT')) return 'å°ç£è™èˆª';
                if(code.startsWith('JL')) return 'æ—¥æœ¬èˆªç©º';
                if(code.startsWith('NH')) return 'å…¨æ—¥ç©º';
                return code.substring(0, 2);
            }

            // 2. è©³è¡¨ PDF è§£æ
            const handleDetailPdf = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                
                // Store Blob URL for preview
                const url = URL.createObjectURL(file);
                setDetailPdfUrl(url);
                setRightTab('detail'); // Switch tab automatically

                setStatus("è§£æè©³ç´°è¡Œç¨‹ (æ™¯é»/é¤é£Ÿ)...");
                const ab = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(ab).promise;
                let text = "";
                for(let i=1; i<=pdf.numPages; i++) {
                    const p = await pdf.getPage(i);
                    const t = await p.getTextContent();
                    text += t.items.map(s=>s.str).join("") + "\n";
                }

                const chunks = text.split(/ç¬¬\s*[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å0-9]+\s*å¤©/);
                const newDays = [...data.days];
                
                if(chunks.length > 1) {
                    for(let i=1; i<chunks.length; i++) {
                        const chunk = chunks[i];
                        const dayIdx = i - 1;
                        if(!newDays[dayIdx]) newDays[dayIdx] = { day: i, location: "æ±äº¬", lat: 35.68, lon: 139.76, spots: [], meals: {b:"",l:"",d:""}, hotel: "", hotelTel: "", hotelAddress: "" };

                        // Meals Logic Update: Use regex to extract until next keyword
                        // Clean up common PDF extraction artifacts first
                        let cleanChunk = chunk.replace(/","/g, "\n").replace(/"/g, "");
                        
                        const bMatch = cleanChunk.match(/æ—©é¤[:ï¼š]([\s\S]*?)(?=åˆé¤|æ™šé¤|ä½å®¿|é…’åº—|æ—…é¤¨|è¡Œç¨‹|$)/);
                        const lMatch = cleanChunk.match(/åˆé¤[:ï¼š]([\s\S]*?)(?=æ™šé¤|ä½å®¿|é…’åº—|æ—…é¤¨|è¡Œç¨‹|$)/);
                        const dMatch = cleanChunk.match(/æ™šé¤[:ï¼š]([\s\S]*?)(?=ä½å®¿|é…’åº—|æ—…é¤¨|è¡Œç¨‹|$)/);

                        if(bMatch) newDays[dayIdx].meals.b = bMatch[1].trim();
                        if(lMatch) newDays[dayIdx].meals.l = lMatch[1].trim();
                        if(dMatch) newDays[dayIdx].meals.d = dMatch[1].trim();

                        // Spots Logic
                        const spots = [];
                        // Improved Regex for ã€Spotã€‘Description
                        const spotRegex = /ã€([^ã€‘]+)ã€‘([^ã€\n]+)/g;
                        const matches = [...chunk.matchAll(spotRegex)];
                        
                        matches.forEach(m => {
                            let desc = m[2].trim();
                            if(desc.length > 150) desc = desc.substring(0, 150) + "...";
                            spots.push({ name: m[1].trim(), desc: desc });
                        });
                        
                        if(spots.length > 0) newDays[dayIdx].spots = spots;

                        let loc = newDays[dayIdx].location;
                        if(chunk.includes("åå¤å±‹")) loc="åå¤å±‹";
                        else if(chunk.includes("é«˜å±±")) loc="é«˜å±±";
                        else if(chunk.includes("ç™½å·")) loc="ç™½å·é„‰";
                        else if(chunk.includes("ä¸‹å‘‚")) loc="ä¸‹å‘‚";
                        else if(chunk.includes("ä»™å°")) loc="ä»™å°";
                        else if(chunk.includes("è—ç‹")) loc="å±±å½¢(è—ç‹)";
                        else if(chunk.includes("æœƒæ´¥")) loc="ç¦å³¶(æœƒæ´¥)";
                        else if(chunk.includes("ç¦å²¡")) loc="ç¦å²¡";
                        else if(chunk.includes("åˆ¥åºœ")) loc="åˆ¥åºœ";
                        else if(chunk.includes("ç†Šæœ¬")) loc="ç†Šæœ¬";
                        else if(chunk.includes("é•·å´")) loc="é•·å´";

                        if(CITIES[loc]) {
                            newDays[dayIdx].location = loc;
                            newDays[dayIdx].lat = CITIES[loc].lat;
                            newDays[dayIdx].lon = CITIES[loc].lon;
                        }
                    }
                }
                
                setData({ ...data, days: newDays });
                setStatus("è©³ç´°è¡Œç¨‹åŒ¯å…¥å®Œæˆï¼");
            };

            const download = () => {
                const html = getClientHtml(data);
                const blob = new Blob([html], {type: 'text/html'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `è¡Œç¨‹App_${data.tripName || 'æœªå‘½å'}.html`;
                document.body.appendChild(a);
                a.click();
            };

            return (
                <div className="flex h-screen bg-gray-100">
                    <div className="w-1/2 p-8 overflow-y-auto bg-white shadow-xl z-10">
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">èªªæ˜æœƒç”¢ç”Ÿå™¨ V31</h1>
                        <p className="text-sm text-gray-500 mb-6">å„ªåŒ–ç‰ˆï¼šç¸½è¡¨è¾¨è­˜ä¿®æ­£ (æ—¥æœŸ/é›»è©±/èˆªç­/ä½å®¿)</p>

                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div className="bg-blue-50 border border-blue-200 p-4 rounded-xl">
                                <h3 className="font-bold text-blue-800 mb-2"><i class="fas fa-list-alt"></i> 1. ä¸Šå‚³ç¸½è¡¨</h3>
                                <input type="file" accept=".pdf" onChange={handleSummaryPdf} className="text-sm w-full" />
                            </div>
                            <div className="bg-green-50 border border-green-200 p-4 rounded-xl">
                                <h3 className="font-bold text-green-800 mb-2"><i class="fas fa-book-open"></i> 2. ä¸Šå‚³è©³è¡¨</h3>
                                <input type="file" accept=".pdf" onChange={handleDetailPdf} className="text-sm w-full" />
                            </div>
                        </div>

                        {status && <div className="bg-yellow-50 text-yellow-700 p-2 rounded mb-4 text-sm text-center font-bold animate-pulse">{status}</div>}

                        <hr className="my-6 border-gray-200" />
                        
                        {/* åŸºæœ¬è³‡æ–™ç·¨è¼¯å€ (æ–°å¢) */}
                        <div className="mb-6 border p-4 rounded-xl bg-indigo-50">
                            <h3 className="font-bold text-indigo-800 mb-2">åŸºæœ¬è³‡æ–™å¾®èª¿</h3>
                            <div className="mb-3">
                                <label className="text-xs text-gray-500 font-bold block mb-1">åœ˜é«”åç¨±</label>
                                <input value={data.tripName} onChange={e=>updateData('tripName', e.target.value)} className="border p-1 rounded text-sm w-full font-bold" placeholder="åœ˜é«”åç¨±" />
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                <div>
                                    <label className="text-xs text-gray-500 font-bold block mb-1">åœ˜è™Ÿ</label>
                                    <input value={data.tripCode} onChange={e=>updateData('tripCode', e.target.value)} className="border p-1 rounded text-sm w-full" placeholder="åœ˜è™Ÿ" />
                                </div>
                                <div>
                                    <label className="text-xs text-gray-500 font-bold block mb-1">å‡ºç™¼æ—¥æœŸ (é¦–é é¡¯ç¤º)</label>
                                    <input value={data.meeting.date} onChange={e=>updateData('meeting', {...data.meeting, date: e.target.value})} className="border p-1 rounded text-sm w-full" placeholder="YYYY/MM/DD" />
                                </div>
                            </div>
                        </div>
                        
                        {/* é›†åˆè³‡è¨Šç·¨è¼¯å€ (ä¸Šæ–¹) */}
                        <div className="mb-6 border p-4 rounded-xl bg-gray-50">
                            <h3 className="font-bold text-gray-700 mb-2">é›†åˆè³‡è¨Šå¾®èª¿</h3>
                            <div className="grid grid-cols-2 gap-2 mb-2">
                                <input value={data.meeting.time} onChange={e=>updateData('meeting', {...data.meeting, time: e.target.value})} className="border p-1 rounded text-sm" placeholder="é›†åˆæ™‚é–“" />
                                <input value={data.meeting.badge} onChange={e=>updateData('meeting', {...data.meeting, badge: e.target.value})} className="border p-1 rounded text-sm" placeholder="è­˜åˆ¥ç‰Œé¡è‰²" />
                            </div>
                            <textarea value={data.meeting.location} onChange={e=>updateData('meeting', {...data.meeting, location: e.target.value})} className="border p-1 rounded text-sm w-full mb-2 h-16 resize-none" placeholder="é›†åˆåœ°é»"></textarea>
                            <div className="grid grid-cols-2 gap-2">
                                <input value={data.guide.name} onChange={e=>updateData('guide', {...data.guide, name: e.target.value})} className="border p-1 rounded text-sm w-full" placeholder="å°éŠå§“å" />
                                <input value={data.guide.twPhone} onChange={e=>updateData('guide', {...data.guide, twPhone: e.target.value})} className="border p-1 rounded text-sm w-full" placeholder="å°éŠé›»è©±" />
                            </div>
                            {/* æ–°å¢æ©Ÿå ´å°ˆå“¡ç·¨è¼¯ */}
                            <div className="grid grid-cols-2 gap-2 mt-2">
                                <label className="text-xs text-gray-500 font-bold block mb-1 col-span-2">æ©Ÿå ´å°ˆå“¡ (å§“å é›»è©±)</label>
                                <input value={data.meeting.airportStaff} onChange={e=>updateData('meeting', {...data.meeting, airportStaff: e.target.value})} className="border p-1 rounded text-sm w-full col-span-2" placeholder="ä¾‹å¦‚: æ›¾ä»æ° 0910-008-139" />
                            </div>
                        </div>

                        {/* èˆªç­è©³ç´°ç·¨è¼¯å€ (æ–°å¢) */}
                        <div className="mb-6 border p-4 rounded-xl bg-blue-50">
                            <h3 className="font-bold text-blue-800 mb-2"><i class="fas fa-plane"></i> èˆªç­è³‡è¨Šè©³å¡«</h3>
                            {data.flights.map((f, idx) => (
                                <div key={idx} className="mb-3 border-b pb-2 last:border-0">
                                    <div className="flex justify-between font-bold text-sm mb-1">{f.type}</div>
                                    <div className="grid grid-cols-2 gap-2 text-xs">
                                        <input value={f.code} onChange={e=>updateFlight(idx, 'code', e.target.value)} className="border p-1 rounded font-bold text-blue-600" placeholder="èˆªç­ä»£è™Ÿ (ä¾‹: JX838)" />
                                        <input value={f.date} onChange={e=>updateFlight(idx, 'date', e.target.value)} className="border p-1 rounded" placeholder="æ—¥æœŸ" />
                                        <input value={f.depTime} onChange={e=>updateFlight(idx, 'depTime', e.target.value)} className="border p-1 rounded" placeholder="å‡ºç™¼æ™‚é–“" />
                                        <input value={f.depAirport} onChange={e=>updateFlight(idx, 'depAirport', e.target.value)} className="border p-1 rounded" placeholder="å‡ºç™¼æ©Ÿå ´" />
                                        <input value={f.arrTime} onChange={e=>updateFlight(idx, 'arrTime', e.target.value)} className="border p-1 rounded" placeholder="æŠµé”æ™‚é–“" />
                                        <input value={f.arrAirport} onChange={e=>updateFlight(idx, 'arrAirport', e.target.value)} className="border p-1 rounded" placeholder="æŠµé”æ©Ÿå ´" />
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* é ˆçŸ¥ç·¨è¼¯å€ (å«åœ–ç‰‡è·¯å¾‘èˆ‡PDFä¸‹è¼‰ã€æœå‹™è²»è¨­å®š) */}
                        <div className="mb-6 border p-4 rounded-xl bg-purple-50">
                            <h3 className="font-bold text-purple-800 mb-2"><i class="fas fa-info-circle"></i> é ˆçŸ¥å…§å®¹ç·¨è¼¯</h3>
                            <div className="space-y-3">
                                <div><label className="text-xs font-bold text-gray-500">å¤©æ°£èˆ‡ç©¿è‘—</label><textarea rows="2" value={data.info.weather} onChange={e=>updateInfo('weather', e.target.value)} className="w-full border rounded p-1 text-sm"></textarea></div>
                                <div><label className="text-xs font-bold text-gray-500">è²¨å¹£åŒ¯ç‡</label><textarea rows="2" value={data.info.currency} onChange={e=>updateInfo('currency', e.target.value)} className="w-full border rounded p-1 text-sm"></textarea></div>
                                <div><label className="text-xs font-bold text-gray-500">è¡Œæ/é›»å£“/ç¦è£½å“</label><textarea rows="2" value={data.info.baggage} onChange={e=>updateInfo('baggage', e.target.value)} className="w-full border rounded p-1 text-sm"></textarea></div>
                                
                                <div className="p-2 border border-yellow-300 bg-yellow-50 rounded">
                                    <label className="text-xs font-bold text-yellow-700 mb-1 block">æœå‹™è²»è¨­å®š</label>
                                    <div className="flex gap-2">
                                        <input type="text" value={data.info.tips.currency} onChange={e=>updateInfo('tips', {...data.info.tips, currency: e.target.value})} className="border p-1 rounded text-xs w-1/3" placeholder="å¹£åˆ¥ (ä¾‹: æ–°å°å¹£)" />
                                        <input type="number" value={data.info.tips.perDay} onChange={e=>updateInfo('tips', {...data.info.tips, perDay: parseInt(e.target.value) || 0})} className="border p-1 rounded text-xs w-1/3" placeholder="æ¯æ—¥é‡‘é¡" />
                                        <input type="number" value={data.info.tips.days} onChange={e=>updateInfo('tips', {...data.info.tips, days: parseInt(e.target.value) || 0})} className="border p-1 rounded text-xs w-1/3" placeholder="å¤©æ•¸" />
                                    </div>
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-gray-500 text-pink-600">åœ–ç‰‡ç¶²å€ / æ³¨æ„äº‹é …åœ–ç‰‡ (å¯å¤šå¼µï¼Œæ›è¡Œåˆ†éš”)</label>
                                    <textarea rows="4" value={data.info.imageRoot} onChange={e=>updateInfo('imageRoot', e.target.value)} className="w-full border border-pink-200 rounded p-1 text-sm text-pink-600" placeholder="å»ºè­°å°‡åœ–ç‰‡æ”¾åœ¨åŒç›®éŒ„æˆ–å­ç›®éŒ„ (imgs/1.jpg)&#10;imgs/2.jpg&#10;æˆ–æ˜¯è¼¸å…¥è³‡æ–™å¤¾è·¯å¾‘ (ä¾‹å¦‚ images/)"></textarea>
                                    <p className="text-[10px] text-gray-400 mt-1">* ç€è¦½å™¨å®‰å…¨æ€§é™åˆ¶ï¼šç„¡æ³•è®€å–ä¸Šä¸€å±¤ (../) çš„åœ–ç‰‡ï¼Œè«‹å°‡åœ–ç‰‡æ”¾åœ¨åŒå±¤æˆ–å­è³‡æ–™å¤¾ã€‚</p>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 text-blue-600">ç´™æœ¬èªªæ˜æœƒ PDF è·¯å¾‘ (é¸å¡«)</label>
                                    <input value={data.info.pdfPath} onChange={e=>updateInfo('pdfPath', e.target.value)} className="w-full border border-blue-200 rounded p-1 text-sm text-blue-600" placeholder="ä¾‹å¦‚: briefing.pdf (å¡«å¯«å¾Œé¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ•)" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 text-green-600">æ»¿æ„åº¦èª¿æŸ¥ç¶²å€ (é¸å¡«)</label>
                                    <input value={data.info.surveyUrl || ''} onChange={e=>updateInfo('surveyUrl', e.target.value)} className="w-full border border-green-200 rounded p-1 text-sm text-green-600" placeholder="https://..." />
                                </div>
                            </div>
                        </div>

                        <div className="space-y-6">
                            {data.days.map((day, dIdx) => (
                                <div key={dIdx} className="border p-4 rounded-xl bg-gray-50 hover:bg-white transition-shadow shadow-sm">
                                    <div className="flex justify-between items-center mb-3 border-b pb-2">
                                        <div className="flex gap-2 items-center flex-1">
                                            <span className="bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold">Day {day.day}</span>
                                            <input value={day.date} onChange={e=>updateDay(dIdx, 'date', e.target.value)} className="border p-1 rounded text-sm w-16 text-center font-bold text-gray-500" placeholder="æ—¥æœŸ" />
                                            <div className="flex gap-1 flex-1">
                                                <select value={Object.keys(CITIES).find(k=>CITIES[k].lat===day.lat) || ''} onChange={e=>updateDay(dIdx, 'location', e.target.value)} className="border p-1 rounded text-sm bg-orange-50 font-bold text-orange-700 w-24">
                                                    {Object.keys(CITIES).map(c=><option key={c} value={c}>{c}</option>)}
                                                </select>
                                                <input value={day.location} onChange={e=>updateDay(dIdx, 'location', e.target.value)} className="border p-1 rounded text-sm w-full" placeholder="è‡ªè¨‚åœ°é»" />
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-1 ml-2">
                                            <button onClick={()=>addSpot(dIdx)} className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200"><i className="fas fa-plus"></i></button>
                                            <button onClick={()=>removeDay(dIdx)} className="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200"><i className="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                    
                                    {/* é¤é£Ÿå¾®èª¿ */}
                                    <div className="grid grid-cols-3 gap-2 mb-3 text-xs">
                                        <div><label className="text-gray-400 block mb-1">æ—©é¤</label><input value={day.meals.b} onChange={e=>updateDay(dIdx, 'meals', {...day.meals, b: e.target.value})} className="border p-1 rounded w-full" /></div>
                                        <div><label className="text-gray-400 block mb-1">åˆé¤</label><input value={day.meals.l} onChange={e=>updateDay(dIdx, 'meals', {...day.meals, l: e.target.value})} className="border p-1 rounded w-full" /></div>
                                        <div><label className="text-gray-400 block mb-1">æ™šé¤</label><input value={day.meals.d} onChange={e=>updateDay(dIdx, 'meals', {...day.meals, d: e.target.value})} className="border p-1 rounded w-full" /></div>
                                    </div>

                                    <div className="space-y-3 mb-3">
                                        {day.spots.map((spot, sIdx) => (
                                            <div key={sIdx} className="bg-white border rounded p-3 relative group">
                                                <input value={spot.name} onChange={e=>updateDaySpot(dIdx, sIdx, 'name', e.target.value)} className="w-full font-bold text-gray-800 border-b mb-2 pb-1 outline-none text-sm" placeholder="æ™¯é»åç¨±" />
                                                <textarea rows="3" value={spot.desc} onChange={e=>updateDaySpot(dIdx, sIdx, 'desc', e.target.value)} className="w-full text-xs text-gray-500 outline-none resize-none" placeholder="æ™¯é»ä»‹ç´¹"></textarea>
                                                <button onClick={()=>removeSpot(dIdx, sIdx)} className="absolute top-2 right-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-trash"></i></button>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex gap-2 text-xs mb-2">
                                        <input value={day.hotel} onChange={e=>updateDay(dIdx, 'hotel', e.target.value)} className="flex-1 border p-1 rounded font-bold" placeholder="ä½å®¿é£¯åº—" />
                                        <input value={day.hotelTel} onChange={e=>updateDay(dIdx, 'hotelTel', e.target.value)} className="w-24 border p-1 rounded" placeholder="é›»è©±" />
                                    </div>
                                    <div className="flex gap-2 text-xs">
                                        <input value={day.hotelAddress} onChange={e=>updateDay(dIdx, 'hotelAddress', e.target.value)} className="flex-1 border p-1 rounded" placeholder="é£¯åº—åœ°å€ (è¼¸å…¥å¾Œæ‰æœƒé¡¯ç¤ºå¸æ©Ÿå¡)" />
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="text-center mb-6 mt-4">
                            <button onClick={addDay} className="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg border-2 border-dashed border-gray-400 w-full transition-colors">
                                <i className="fas fa-plus-circle mr-1"></i> æ–°å¢ä¸€å¤©è¡Œç¨‹ (Day {data.days.length + 1})
                            </button>
                        </div>

                        <button onClick={download} className="w-full mt-8 bg-jp-indigo hover:bg-blue-800 text-white py-4 rounded-xl font-bold text-lg shadow-lg transition-transform active:scale-95">
                            <i class="fas fa-download mr-2"></i> åŒ¯å‡ºå®¢æˆ¶ç«¯ç¶²é  (HTML)
                        </button>
                    </div>

                    <div className="w-1/2 bg-gray-200 flex flex-col h-screen">
                        {/* Right Tabs */}
                        <div className="flex border-b bg-white">
                            <button 
                                className={`flex-1 py-3 font-bold text-sm ${rightTab === 'preview' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}
                                onClick={() => setRightTab('preview')}
                            >
                                <i className="fas fa-mobile-alt mr-2"></i> å³æ™‚é è¦½
                            </button>
                            <button 
                                className={`flex-1 py-3 font-bold text-sm ${rightTab === 'summary' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}
                                onClick={() => setRightTab('summary')}
                            >
                                <i className="fas fa-file-pdf mr-2"></i> ç¸½è¡¨ PDF
                            </button>
                            <button 
                                className={`flex-1 py-3 font-bold text-sm ${rightTab === 'detail' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}
                                onClick={() => setRightTab('detail')}
                            >
                                <i className="fas fa-file-alt mr-2"></i> è©³è¡¨ PDF
                            </button>
                        </div>

                        {/* Content Area */}
                        <div className="flex-1 overflow-hidden relative bg-gray-200">
                            {rightTab === 'preview' && (
                                <div className="w-full h-full flex items-center justify-center p-4">
                                    <div className="phone-frame w-[375px] h-[750px] shadow-2xl relative bg-white scale-90 sm:scale-100 transition-transform origin-center">
                                        <div className="phone-notch"></div>
                                        <iframe srcDoc={getClientHtml(data)} className="w-full h-full border-none rounded-[2rem]"></iframe>
                                    </div>
                                </div>
                            )}

                            {rightTab === 'summary' && (
                                <div className="w-full h-full p-4">
                                    {summaryPdfUrl ? (
                                        <iframe src={summaryPdfUrl} className="w-full h-full rounded-xl shadow-lg border bg-white"></iframe>
                                    ) : (
                                        <div className="h-full flex flex-col items-center justify-center text-gray-400">
                                            <i className="fas fa-file-pdf text-6xl mb-4 opacity-30"></i>
                                            <p>å°šæœªä¸Šå‚³ç¸½è¡¨ PDF</p>
                                        </div>
                                    )}
                                </div>
                            )}

                            {rightTab === 'detail' && (
                                <div className="w-full h-full p-4">
                                    {detailPdfUrl ? (
                                        <iframe src={detailPdfUrl} className="w-full h-full rounded-xl shadow-lg border bg-white"></iframe>
                                    ) : (
                                        <div className="h-full flex flex-col items-center justify-center text-gray-400">
                                            <i className="fas fa-file-alt text-6xl mb-4 opacity-30"></i>
                                            <p>å°šæœªä¸Šå‚³è©³è¡¨ PDF</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GeneratorApp />);
    </script>
</body>
</html>